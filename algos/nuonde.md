## Nuonde アルゴリズム：高度な時間周波数統合に基づく音響イベント検出手法

**要約**

本稿では、音楽や音声信号から音符イベント（オンセット、オフセット、ピッチ）を高精度に検出するための新しいアルゴリズム「Nuonde (新音検出)」を提案する。Nuonde は、信号の局所的な特性と大域的な構造を捉えるために、複数の先進的な信号処理技術を統合している点に特徴がある。具体的には、(1) 周波数に応じて時間・周波数解像度を最適化する適応的時間-周波数表現（TFR）、(2) 情報量最大化や微分幾何学の概念を取り入れた最適TFR、(3) 時間的に変化する背景ノイズをモデル化する動的背景モデル、(4) TFR の局所的な安定性や滑らかさを評価する構造的一貫性/コヒーレンス指標、(5) 複数の特徴量を情報理論的に統合する高度な相乗効果指標（Synergy Index）、(6) 調和構造分析と時間的連続性を考慮した高精度なピッチ軌跡抽出、(7) 多様な特徴量の時間変化を捉える複合的な音符境界検出、を主要な構成要素とする。これらの要素を組み合わせることで、ノイズ環境下や複雑な楽曲においても、より頑健で精度の高い音響イベント検出を目指す。

**1. はじめに**

音楽情報検索（MIR）や自動採譜、音声分析などの分野において、音声信号から基本的な構成要素である音符（ノート）の情報を正確に抽出することは極めて重要である。従来の多くの手法は、オンセット検出、ピッチ推定、オフセット検出を独立したタスクとして扱ったり、特定の信号特性（例: エネルギー変化、位相情報）に強く依存したりする傾向があった。しかし、実際の音楽信号は、背景ノイズ、楽器の音色変化、複数の音の重なり（多音）、急速なパッセージなど、複雑な要素を含むため、これらの手法では限界があった。

特に、(1) 時間解像度と周波数解像度の間の基本的なトレードオフ、(2) 背景ノイズと前景イベントの分離の難しさ、(3) パーカッシブな音と楽音の識別、(4) 多音環境下での正確なピッチ推定、(5) 微妙な音符境界の特定、などが課題として挙げられる。

本稿で提案する Nuonde アルゴリズムは、これらの課題に対処するため、時間-周波数領域における信号の多角的な分析と統合に焦点を当てる。適応的な時間-周波数表現を用いることで解像度の問題を緩和し、動的な背景モデルでノイズ耐性を向上させる。さらに、信号の構造的な安定性、複雑性、周期性、調和性といった複数の特徴量を算出し、これらを情報理論的な枠組みも取り入れて統合することで、音符らしさを表す「相乗効果指標」を生成する。この指標と、高精度化されたピッチ軌跡情報、および複数の特徴量の時間変化を組み合わせることで、最終的に音符の境界とピッチを頑健に推定する。本稿では、Nuonde アルゴリズムを構成する各要素技術と、それらを統合した検出プロセスについて詳述する。

**2. アルゴリズム概要**

Nuonde アルゴリズムは、以下の主要なステップで構成される。

1.  **時間-周波数表現 (TFR) 計算:** 入力音声信号に対し、周波数に応じて時間・周波数解像度を調整する適応的 TFR、または情報量最大化に基づく最適 TFR を計算する。
2.  **動的背景モデル計算:** TFR から時間変化する背景ノイズレベルを推定する。
3.  **特徴量計算:** TFR の局所的な特性を捉える複数の特徴量を計算する。
    *   構造的一貫性 / コヒーレンス: TFR の時間的・周波数的な滑らかさ・安定性。
    *   構造的複雑性: TFR の局所的な情報量や乱雑さ。
    *   周期性: 信号の時間的な繰り返しパターン。
4.  **相乗効果指標 (Synergy Index) 計算:** 背景からの逸脱度と上記の特徴量を統合し、各時間-周波数点における音符らしさ（顕著性）を示す指標を算出する。
5.  **ピッチ軌跡抽出:** 相乗効果指標と調和構造分析、時間的連続性を考慮し、フレームごとの基本周波数（F0）の軌跡とその信頼度を推定する。
6.  **音符境界検出:** ピッチ軌跡、エネルギー変化、スペクトル新規性、相乗効果指標の時間変化など、複数の情報源を統合した複合的なオンセット/オフセット関数を生成し、ピーク検出によって音符の開始・終了候補点を特定する。
7.  **音符生成:** 検出された音符境界とピッチ軌跡情報に基づき、最終的な音符リスト（開始時間、終了時間、代表ピッチ）を生成する。

**3. 時間-周波数表現 (Time-Frequency Representation)**

信号の時間的変化と周波数成分を同時に捉える TFR は、本アルゴリズムの基盤となる。Nuonde では、固定的な STFT の限界を超えるために、2種類の高度な TFR 計算手法を実装している。

**3.1. 適応的 TFR (`compute_adaptive_tfr`)**

非定常 Gabor 変換の考え方に基づき、分析する周波数に応じて STFT の窓長を適応的に変化させる。具体的には、低周波数成分に対しては周波数解像度を重視して長い窓を、高周波数成分に対しては時間解像度を重視して短い窓を使用する。これにより、音楽信号に多く見られる対数的な周波数構造により適合した表現を得ることを目指す。窓サイズは周波数 `f` に対して `sr * C / f`（`C` は定数、例: 8）のように設定され、実装上は計算効率のために2のべき乗に丸められる。最終的な TFR は、各周波数に対して計算された STFT の該当する周波数ビンの振幅をマージし、対数スケール (`log1p`) に変換して生成される。

**3.2. 最適 TFR (`compute_optimal_tfr`)**

より理論的なアプローチとして、情報量最大化または信号の内在的構造保存の観点から TFR を構築する。本実装では、ガボールウェーブレットを基底関数として用いる。

*   **解析信号:** まず、ヒルベルト変換を用いて入力信号を解析信号に変換し、瞬時振幅と瞬時位相（および瞬時周波数）を抽出する。
*   **周波数ビン:** 音楽理論に基づき、対数スケール（オクターブあたり `beta` ビン、例: 12）で中心周波数を配置する。
*   **ガボールウェーブレット:** 各中心周波数 `cf` に対して、不確定性原理に基づき時間解像度と周波数解像度のバランスが取れるような帯域幅 (`bandwidth = cf * sqrt(2) / beta`) と時間窓幅 (`sigma_t = sqrt(1 / (2 * pi * bandwidth))`) を持つガボールウェーブレット（窓関数で変調された複素正弦波）を構築する。
*   **TFR 計算:** 入力信号と各ガボールウェーブレットとの畳み込み演算により、複素 TFR を得る。
*   **時間ステップ:** 物理的な時間経過により忠実な表現を得るために、固定ではなく適応的な時間ステップ（例: 10ms）で TFR をサンプリングする。
*   **最終処理:** 複素 TFR の絶対値を取り、対数スケールに変換する。

この最適 TFR は、信号の構造をより忠実に反映する可能性があるが、計算コストは適応的 TFR よりも高くなる傾向がある。

**4. 背景モデリングと特徴量計算**

TFR から前景イベント（音符）を効果的に抽出するために、背景ノイズのモデル化と、信号の構造的特性を表す特徴量の計算を行う。

**4.1. 動的背景モデル (`compute_dynamic_background`)**

時間-周波数表現 `tfr(f, t)` の各点における背景ノイズレベル `background(f, t)` を推定する。基本的な考え方は指数移動平均 (EMA) であるが、前景イベントが背景モデルに誤って取り込まれるのを防ぐ工夫が施されている。

*   **更新式:**
    *   もし `tfr(f, t)` が `background(f, t-1)` に比べて十分に小さい（`tfr(f, t) <= background(f, t-1) * (1 + background_threshold)`）ならば、背景とみなし、EMA で更新する：
        `background(f, t) = (1 - rate) * background(f, t-1) + rate * tfr(f, t)`
    *   もし `tfr(f, t)` が大きい（閾値を超える）ならば、前景イベントの可能性が高いと判断し、背景モデルを更新せず、前フレームの値を保持する：
        `background(f, t) = background(f, t-1)`
*   **パラメータ:** `background_adaptation_rate (rate)`, `background_threshold`。

**4.2. 構造的一貫性 / コヒーレンス**

TFR 上の局所的なパターンの安定性や滑らかさを定量化する。

*   **`compute_structural_consistency`:** 時間方向の局所ウィンドウ（サイズ `window_size`）を取り、そのウィンドウ内の変動係数（標準偏差/平均）を計算する。変動係数が小さいほど構造が一貫している（安定している）と判断し、その逆数を一貫性係数とする (`1 / (1 + variation_coef)`)。単純だが、時間的な安定性を捉えるのに有効である。
*   **`compute_structural_coherence`:** より高度なアプローチとして、TFR を位相空間上の多様体とみなし、その局所的な曲率を計算する。実装では、TFR の周波数方向と時間方向の勾配（1階微分）とヘッセ行列（2階微分）を近似的に計算し、リッチ曲率に類似した指標を算出する (`det(Hessian) / trace(Hessian)`)。曲率が小さい（局所的に平坦に近い）ほどコヒーレンス（一貫性）が高いと評価する (`1 / (1 + |curvature|)`)。さらに、変動の異方性（周波数方向と時間方向の変化の度合いの違い）を考慮し、等方的な変化（両方向に均等に変化）をより高く評価する補正を加える。最後に、ガウシアンフィルタによる平滑化を行う。

**4.3. 相乗効果指標 (Synergy Index)**

複数の特徴量を統合し、各時間-周波数点が音符の一部である可能性（顕著性）を示す単一の指標を計算する。

*   **`compute_synergy_index`:** 比較的単純な統合方法。
    1.  背景からの逸脱度: `deviation = 1 - 1 / (1 + tfr / background)` を計算。これは TFR が背景に対して大きいほど 1 に近づく。
    2.  統合: `synergy = deviation * consistency`。背景から逸脱し、かつ構造的に安定している点を高く評価する。
    3.  平滑化: 時間方向にメディアンフィルタを適用し、スパイク状のノイズを除去する。
*   **`compute_synergy_index_advanced`:** より多くの情報源を統合する高度な方法。
    1.  情報利得 (KL ダイバージェンス): 背景モデルの確率分布 `p_background` に対する現在の信号の確率分布 `p_signal` の情報利得を計算 (`p_signal * log(p_signal / p_background)`)。背景から大きく異なるパターンほど高い値を持つ。
    2.  コヒーレンスによる重み付け: `weighted_info = info_gain * coherence`。情報利得があり、かつ構造的にコヒーレントな点を重視。
    3.  時間的連続性: 各周波数ビンにおける信号の時間方向の自己相関を計算し、その減衰率から連続性の高さを評価。減衰が遅いほど連続性が高い。
    4.  周波数的相互情報量: 隣接する周波数ビン間の局所的な相互情報量を計算。エネルギーが特定の周波数帯域に集中しているほど値が低く（相関が低い）、広く分布していると高い値を持つ傾向（実装では逆？要確認：エントロピーベースなので高いと分散）。→ 実装では `1 - entropy / max_entropy` なので、エントロピーが低い（集中している）ほど相互情報量スコアは高くなる。隣接ビンが似た動きをする（情報量的に関連している）度合い。
    5.  最終統合: これらの指標を重み付け加算 (`synergy = weighted_info + 0.3 * continuity + 0.2 * mutual_info`)。
    6.  非線形強調: `tanh` 関数を用いて、重要なパターンをより際立たせる。

**5. ピッチ検出**

フレームごとの基本周波数（F0）を推定する。

*   **基本推定 (`detect_pitch`):** 各時間フレーム `t` において、相乗効果指標 `synergy(:, t)` が最大となる周波数 `freqs[argmax(synergy(:, t))]` をそのフレームのピッチ候補とする。ただし、最大値が閾値 `synergy_threshold` 未満の場合は 0 Hz（無声）とする。
*   **調和構造分析 (`analyze_harmonic_structure`):** ピッチ候補の信頼性を高めるために、その候補周波数を F0 と仮定した場合の倍音構造を TFR 上で検証する。観測された倍音パターン（エネルギー減衰、存在比率、周波数整合性など）と、理想的な倍音パターンを比較し、スコアを算出する。楽器音らしい倍音構造を持つ候補ほど高いスコアを得る。
*   **高調波プロファイルと信頼度補正 (`compute_harmonic_profile`, `detect_harmonics`):** 推定された F0 に基づき、TFR から倍音の相対的な強度プロファイルを計算する。このプロファイルの形状（倍音の存在感）を用いて、元のピッチ信頼度を補正（上昇）する。また、F0 の半分の周波数（サブハーモニクス）に強いエネルギーが存在しないかチェックし、存在する場合はオクターブエラーの可能性として信頼度を減衰させる。
*   **ピッチ軌跡補正 (`_correct_pitch_trajectory`, `_correct_pitch_trajectory_enhanced`):** 推定されたピッチの時系列（軌跡）に対して、時間的に不自然な跳躍や短すぎる有声区間を除去するための後処理を行う。メディアンフィルタによる平滑化、オクターブエラーの補正、短いギャップの補間などを含む。
*   **高精度ピッチ軌跡抽出 (`extract_pitch_trajectories`):** 複数の情報源を統合し、時間的な連続性を考慮して最適なピッチ軌跡を探索する。
    1.  追加特徴量（スペクトル流量、重心、平坦度）を計算。
    2.  各フレームで複数のピッチ候補を生成（Synergy ピーク + 調和構造分析）。
    3.  各候補の信頼度（ピッチ確率）を計算。
    4.  動的計画法（ビタビアルゴリズムに類似）を用いて、観測確率（信頼度）と遷移確率（周波数変化のコスト、オクターブ跳躍は低コスト）に基づいて、最も尤もらしいピッチ状態系列（軌跡）を決定する。
    5.  信頼度閾値と最小セグメント長でフィルタリング。

**6. 音符境界検出 (`detect_note_boundaries`)**

ピッチ検出とは別に、または連携して、音符の開始（オンセット）と終了（オフセット）の精密なタイミングを検出する。

*   **複合オンセット/オフセット関数:** 複数の特徴量の時間微分や変化量を統合して、オンセットらしさ、オフセットらしさを表す関数を構築する。
    *   寄与する特徴量: 全帯域エネルギー変化、帯域別エネルギー変化、スペクトル新規性（隣接フレーム間のスペクトル相関の低さ）、相乗効果指標の変化、ピッチ信頼度の変化。
    *   統合方法: 各特徴量の正（オンセット用）または負（オフセット用）の変化量を、エネルギーレベルなどに応じて重み付けして加算する。
*   **ピーク検出:** 生成されたオンセット関数とオフセット関数に対して、ピーク検出アルゴリズム（適応的閾値処理と局所的最大値探索、最小ピーク間隔制約）を適用し、境界候補点を特定する。
*   **候補統合:** ピーク検出結果と、ピッチ軌跡から得られる有声/無声区間の遷移情報を組み合わせて、最終的なオンセット・オフセットフレームを決定する。

**7. 音符生成 (`detect_notes`)**

抽出されたピッチ軌跡と音符境界情報から、最終的な音符リストを生成する。

*   各音符区間（オンセット〜オフセット）について、その区間内の有効な（> 0 Hz）フレームピッチを集計する。
*   集計されたピッチの中央値 (median) をその音符の代表ピッチとする。
*   音符の持続時間が `min_note_length` 未満の場合や、区間内に有効なピッチが存在しない場合は、その音符を除外する。

**8. 結論**

Nuonde アルゴリズムは、適応的/最適 TFR、動的背景モデル、構造的特徴量（一貫性、複雑性、周期性）、情報理論的指標、調和構造分析、複合的な境界検出関数など、複数の先進的な信号処理技術を統合することで、従来の課題に対処し、高精度な音響イベント検出を実現する。特に、情報量や幾何学的構造に着目した TFR 分析や、複数の手がかりを統合した Synergy Index およびピッチ軌跡抽出、境界検出は、本アルゴリズムの独自性と性能向上に貢献する主要な要素である。今後の課題としては、計算コストの最適化や、より多様な楽器・音楽ジャンルへの適応性向上が挙げられる。
