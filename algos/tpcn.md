## TPCN (Temporal Phase Contrast Network): 位相コントラストに基づく音響イベント統合検出アルゴリズム

**要約**

本稿では、音楽信号からの高精度なオンセット、ピッチ、およびノート区間検出のための新しいアルゴリズム「TPCN (Temporal Phase Contrast Network)」を提案する。TPCNの核心的な独自性は、従来の振幅スペクトル情報に加え、位相情報の構造的な特徴を捉える新しい指標「位相コントラスト (Phase Contrast, PC)」を導入し、これをピッチサリエンス推定に統合する点にある。位相コントラストは、基本周波数（F0）候補の倍音列が存在すると期待される周波数ビンにおける位相安定度（SPOD: Short-time Phase Oscillation Detector）と、それらの倍音間の周波数領域（谷）における位相安定度との差分として定義される。調和構造を持つ楽音成分が存在する場合、倍音周波数付近の位相は安定し、倍音間の位相は不安定になる（ノイズや他の成分の影響を受けやすい）という仮説に基づき、このコントラストが大きいほど、そのF0候補の確からしさが高いと判断する。TPCNは、この位相コントラストによって重み付け（ブースト）されたピッチサリエンス \(PS_{\lambda}\) を計算し、その時間変化からオンセットを検出し、閾値処理とノートトラッキングによってノート区間とピッチを一貫して推定する。単一のメタパラメータ \(\lambda\) により位相コントラストの寄与度を調整可能であり、ノイズや多音環境における頑健性と適応性を提供する。

**1. はじめに**

音響信号からの音符イベント（オンセット、オフセット）およびピッチ（F0）の自動抽出は、音楽情報検索（MIR）、自動採譜、音声合成など多岐にわたる分野で不可欠な基盤技術である。既存のアプローチは、エネルギー変化、スペクトル形状、高調波構造、位相情報など、様々な音響特徴量を利用してきた。特に、位相情報は信号の微細な時間構造を反映しており、オンセット検出やピッチ推定において有用な情報源となりうる。Short-time Phase Oscillation Detector (SPOD) [1] などの手法は、位相の安定度を測定し、調和成分の存在を示唆する指標として利用されてきた。

しかし、従来の位相安定度に基づく手法は、単に各周波数ビンにおける安定度を評価するに留まることが多かった。実際の音楽信号では、調和構造を持つ音（楽音）が存在する場合、その倍音列に対応する周波数ビンでは位相が安定する一方、倍音と倍音の間の周波数領域（谷）では、背景ノイズや他の楽器音の非調波成分、位相干渉などの影響により、位相が不安定になる傾向があると考えられる。

本稿で提案するTPCNアルゴリズムは、この「倍音ピーク」と「倍音間の谷」における位相安定度の**差異（コントラスト）**に着目する。我々は、この位相コントラスト（PC）が、真の調和構造を持つ音響イベントの存在をより明確に示す指標となりうると考えた。TPCNでは、F0候補ごとに、その倍音列に対応する周波数ビンの平均SPOD値（\(\overline{S}_{peaks}\)）と、倍音間の谷領域の平均SPOD値（\(\overline{S}_{valleys}\)）を計算し、その差分 \(PC_{diff} = \overline{S}_{peaks} - \overline{S}_{valleys}\) を位相コントラストとして定義する。

さらに、この位相コントラストを、従来の調波振幅エビデンス（Harmonic Magnitude Evidence, HME）と統合する。メタパラメータ \(\lambda\) を導入し、位相コントラストの大きさに応じてHMEを指数関数的に強調（ブースト）する新しいピッチサリエンス指標 \(PS_{\lambda}\) を提案する。

\[ PS_{\lambda}(f_c, t) = HME(f_c, t) \cdot \exp(\lambda \cdot \max\{0, PC_{diff}(f_c, t)\}) \]

この \(PS_{\lambda}\) は、振幅が大きくかつ倍音列の位相コントラストが明確なF0候補に対して高い値を示す。TPCNは、この \(PS_{\lambda}\) の時間変化からオンセットを検出し、その値に基づいてピッチ候補を選択し、ノートトラッキングを行うことで、オンセット、ピッチ、ノート区間を一貫した枠組みで推定する。

**2. アルゴリズム詳細**

TPCNアルゴリズムは以下の主要なステップで構成される。

**2.1 前処理: STFTとSPOD計算**

1.  **STFT:** 入力音声信号 \(x[n]\) から、短時間フーリエ変換（STFT）を用いて複素スペクトログラム \(X(t, k)\) を計算する。ここで \(t\) はフレームインデックス、\(k\) は周波数ビンインデックスである。振幅スペクトル \(A(t, k) = |X(t, k)|\) と位相スペクトル \(\phi(t, k) = \angle X(t, k)\) を得る。フレーム時刻 \(frame\_times\) も計算・保持する。
2.  **SPOD:** 位相スペクトル \(\phi(t, k)\) から、時間軸方向の位相安定度マップ \(S(t, k)\) を計算する。これは、各時間-周波数点における瞬時周波数の局所的な分散の低さ（安定性）を示す指標であり、[0, 1] の範囲に正規化される。計算方法はPZSTD [1] など既存の手法に準拠する。

**2.2 F0候補リスト生成**

分析対象とするピッチ範囲 \([min\_freq, max\_freq]\) を、対数周波数（セント）スケール上で一定の分解能（例: `f0_candidate_resolution_cents`）で分割し、\(K\) 個のF0候補周波数 \(f_c\) のリストを作成する。

**2.3 TPCNピッチサリエンス \(PS_{\lambda}\) の計算**

各フレーム \(t\) および各F0候補 \(f_c\) に対して、以下の計算を行う。

1.  **調波振幅エビデンス (HME) の計算:**
    *   \(f_c\) の倍音周波数 \(f_h = h \cdot f_c \cdot \sqrt{1 + I h^2}\) （\(h=1, ..., H_{max}\), \(I\) はインハーモニシティ係数、省略可）に対応する周波数ビン \(k_h\) を特定する。
    *   各倍音ビンの振幅 \(A(t, k_h)\) を、倍音次数 \(h\) に応じた重み（例: \(1/h\)）で加重和し、HMEを計算する。
        \[ HME(f_c, t) = \sum_{h=1}^{H_{max}} w_h \cdot A(t, k_h) \quad (\text{e.g., } w_h = 1/h) \]

2.  **位相コントラスト (PC) の計算:**
    *   **倍音ピークSPOD (\(\overline{S}_{peaks}\)):** 倍音ビン \(k_h\) におけるSPOD値 \(S(t, k_h)\) を、HMEと同様の重み \(w_h \cdot A(t, k_h)\) で加重平均する。
        \[ \overline{S}_{peaks}(f_c, t) = \frac{\sum_{h=1}^{H_{max}} w_h A(t, k_h) S(t, k_h)}{\sum_{h=1}^{H_{max}} w_h A(t, k_h) + \epsilon} \]
        （\(\epsilon\) はゼロ除算防止の微小値）
    *   **倍音間谷SPOD (\(\overline{S}_{valleys}\)):** 倍音 \(f_h\) と \(f_{h+1}\) の間の周波数領域（谷領域）に対応する周波数ビン \(k_v\) を特定する。これらのビンのSPOD値 \(S(t, k_v)\) を、同様に振幅 \(A(t, k_v)\) などで重み付け平均する。谷領域の定義や重み付けは実装により異なる（例: \(f_h\) と \(f_{h+1}\) の中間付近のビン、重みは一定または振幅依存）。
        \[ \overline{S}_{valleys}(f_c, t) = \frac{\sum_{v \in \text{Valleys}} w'_v A(t, k_v) S(t, k_v)}{\sum_{v \in \text{Valleys}} w'_v A(t, k_v) + \epsilon} \]
    *   **位相コントラスト差:**
        \[ PC_{diff}(f_c, t) = \overline{S}_{peaks}(f_c, t) - \overline{S}_{valleys}(f_c, t) \]

3.  **位相コントラスト重み付けサリエンス \(PS_{\lambda}\) の計算:**
    *   HMEとPCを統合する。位相コントラストが正の場合のみ、その値に応じてHMEを指数関数的に強調する。
        \[ PS_{\lambda}(f_c, t) = HME(f_c, t) \cdot \exp(\lambda \cdot \max\{0, PC_{diff}(f_c, t)\}) \]
    *   メタパラメータ \(\lambda \ge 0\) は、位相コントラストの寄与度を制御する。\(\lambda=0\) の場合は従来のHME（振幅ベースサリエンス）と等価になる。\(\lambda > 0\) では、倍音列の位相構造が明確な（PCが大きい）F0候補のサリエンスが相対的に高まる。

**2.4 オンセットスコア \(OS_{TPCN}\) の計算**

ピッチサリエンス \(PS_{\lambda}\) の時間的な立ち上がりをオンセットの指標とする。

\[ OS_{TPCN}(f_c, t) = \max\{0, PS_{\lambda}(f_c, t) - PS_{\lambda}(f_c, t-1)\} \]

これは、特定のピッチ \(f_c\) における調和構造と位相コントラストが急峻に立ち上がる瞬間を捉える。

**3. イベント検出とノート抽出**

計算されたピッチサリエンス \(PS_{\lambda}\) とオンセットスコア \(OS_{TPCN}\) に基づき、ノートイベントを検出・抽出する。

**3.1 フレーム毎ピッチ推定:**

各フレーム \(t\) において、\(PS_{\lambda}(f_c, t)\) が閾値 \(\theta_{PS}\) を超える \(f_c\) をそのフレームのピッチ候補とする。マルチピッチを許容する場合は、閾値を超える複数のピークを選択する（必要に応じてNMS等を適用）。ここでは最も単純なケースとして、最大の \(PS_{\lambda}\) を与える \(f_c\) をフレームピッチ \(F_0(t)\) とする。
\[ F_0(t) = \begin{cases} \arg\max_{f_c} PS_{\lambda}(f_c, t) & \text{if } \max_{f_c} PS_{\lambda}(f_c, t) > \theta_{PS} \\ 0 & \text{otherwise} \end{cases} \]

**3.2 ノートトラッキング（状態機械ベース）:**

各F0候補（またはフレームの主要ピッチ）に対して、ノートの状態（非アクティブ、アクティブ）を追跡する。

*   **オンセット:** フレーム \(t\) で \(F_0(t) > 0\) かつ \(F_0(t-1) = 0\) となった場合、または、\(F_0(t) > 0\) かつ \(OS_{TPCN}(F_0(t), t)\) がオンセット閾値 \(\theta_O\) を超えた場合に、ピッチ \(F_0(t)\) のノートが開始したと判定する。
*   **継続:** 前フレーム \(t-1\) でアクティブだったピッチ \(f_{prev}\) が、現在のフレーム \(t\) でも \(F_0(t)\) が \(f_{prev}\) に近い値（例: ±50セント以内）で、かつ \(PS_{\lambda}(F_0(t), t) > \theta_{PS}\) を満たす場合に、ノートが継続していると判定する。
*   **オフセット:** アクティブだったノートのピッチに対応する \(PS_{\lambda}(f_c, t)\) が、閾値 \(\theta_{PS}\) を下回り、それが一定フレーム数 \(\Delta T_{offset}\) 以上継続した場合に、ノートが終了したと判定する。

（注意: 上記は簡易的な状態機械の例。実際には、複数のピッチ候補を同時に追跡するマルチターゲットトラッキング手法（例: Hungarian Algorithm, Particle Filter）を適用することが望ましい。）

**3.3 ノートピッチ確定と後処理:**

検出されたノート区間（オンセットフレーム \(t_{on}\) からオフセットフレーム \(t_{off}\) まで）に対して、代表ピッチを決定する。

*   **代表ピッチ:** 区間内のフレームピッチ \(F_0(t)\) (\(t_{on} \le t < t_{off}\)) を、ピッチサリエンス \(PS_{\lambda}(F_0(t), t)\) で重み付けした平均値や中央値などを計算し、ノートのピッチとする。
*   **後処理:**
    *   持続時間が非常に短い（例: `min_note_duration` 未満）ノートを除去する。
    *   時間的に近接し、かつピッチが非常に近いノートを統合する。
    *   ノート内のピッチ変動が大きいノートを除去またはフラグ付けする。

**4. 新規性と利点**

TPCNアルゴリズムの新規性と独自性は、以下の点に集約される。

1.  **位相コントラスト (PC) の導入:** SPODを単独で使うのではなく、「倍音ピーク」と「倍音間の谷」におけるSPOD値の**差分**を計算し、調和構造の明確さを示す新しい指標として利用する点。これは、位相情報の構造的な側面に注目した独自のアプローチである。
2.  **\(PS_{\lambda}\) (位相コントラスト重み付けサリエンス) の定義:** 従来の振幅ベースの調波エビデンス (HME) を、位相コントラスト (PC) を用いて適応的に強調する新しいサリエンス計算式を提案する点。メタパラメータ \(\lambda\) により、位相情報の寄与度を柔軟に調整できる。
3.  **統合的検出フレームワーク:** オンセット検出（\(PS_{\lambda}\) の時間微分に基づく）、ピッチ推定（\(PS_{\lambda}\) のピークに基づく）、ノートトラッキング（\(PS_{\lambda}\) の閾値と時間変化に基づく）を、単一のサリエンス指標 \(PS_{\lambda}\) から一貫して導出する点。

これにより、以下の利点が期待される。

*   **オンセット検出精度の向上:** 位相コントラストは、倍音構造が明確に立ち上がるオンセット瞬間を鋭敏に捉えるため、エネルギーや振幅の変化だけでは検出しにくいソフトなオンセットや、ノイズ中のオンセット検出性能が向上する可能性がある。
*   **ピッチ推定の頑健性向上:** 位相構造が不明瞭なノイズ成分や非調波成分の影響を受けにくくなり、特に多音環境やノイズ環境下でのピッチ推定精度が向上する可能性がある。
*   **パラメータ調整の容易性:** メタパラメータ \(\lambda\) を調整することで、信号の特性（S/N比、調波構造の明瞭さなど）に応じて、振幅情報と位相情報のバランスを容易に変更できる。
*   **計算効率:** 位相コントラストの計算は、既存のSPODマップから比較的少ない追加計算で実現可能であり、リアルタイム処理への適用も現実的である。

**5. 結論**

TPCNアルゴリズムは、位相情報の構造的な特徴である「位相コントラスト」を新たに定義し、これを振幅情報と統合することで、音響イベント検出のための新しいピッチサリエンス指標 \(PS_{\lambda}\) を提案するものである。この指標を用いることで、オンセット、ピッチ、ノート区間を統一的な枠組みで推定することが可能となり、特にオンセット検出やノイズ・多音環境下でのピッチ推定において、従来手法を上回る性能を発揮する潜在力を持つ。メタパラメータ \(\lambda\) による柔軟な調整可能性も、実用上の利点となる。今後の研究では、マルチターゲットトラッキング手法の導入による多音分離性能の向上や、様々な音響条件下でのパラメータ最適化が課題となる。
