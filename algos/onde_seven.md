# アルゴリズム仕様書

---

## 1. 発明の名称 / 技術名称
**RFS/PHDフィルタに基づく統合型動的アンチパターンピッチ検出アルゴリズム (ONDE-SEVEN)**

---

## 2. 技術分野
本アルゴリズムは、音楽音響信号を対象とした**マルチターゲット追跡**および**複数同時ピッチ推定**に関する。特に、**確率的フレームワーク**を用いてオンセット／オフセットの推定やノイズ・干渉音（クラッタ）環境下における高精度な信号解析を実現する技術である。

---

## 3. 背景技術と課題

### 3.1 従来のマルチピッチ推定
- 従来の音楽信号解析においては、フレームごとのピーク検出やスペクトルテンプレートマッチングを用いたマルチピッチ推定が多数提案されてきた。しかし、以下のような課題がある:
  1. **信号モデルの単純化**: 同時多音（ポリフォニー）で音が交錯する場合、部分音追跡の困難やノイズ混入により誤検出が増える。  
  2. **オンセット／オフセット推定の不確実性**: 時間軸での変動が激しい場合、局所的なピーク／ゼロクロスだけでは不安定になりがち。  
  3. **可変数の多さ**: フレーム単位で複数音を推定する際に、各音の存在／非存在を都度判断する必要があるが、決定境界や閾値設定が複雑になりやすい。

### 3.2 RFS（Random Finite Set）理論とPHDフィルタ
- **RFS理論**は、物体追跡やロボティクス分野のマルチターゲット追跡問題を統計的に処理するフレームワークであり、不確実性の高い環境下でも**目標の数と状態**を同時に推定できる。  
- **PHD（Probability Hypothesis Density）フィルタ**は、RFS理論の一手法で、マルチターゲット追跡をガウス混合モデルなどで効率的に実装可能。生存／誕生／消失／観測の確率モデルを組み込むことで、フレーム間での音楽イベント（ピッチ）の動的変化を捉える。

### 3.3 本アルゴリズムの目的
本アルゴリズムは、RFS/PHDフィルタを**音楽信号のマルチピッチおよびオンセット／オフセット推定**へ応用した統合的システムであり、以下の点を狙う:
1. **複数同時音（ポリフォニー）にも頑健**に追従。  
2. **クラッタ（ノイズや不要ピーク）**を含むスペクトル環境でも高精度に音楽的イベントを抽出。  
3. **動的確率モデル**による連続フレーム間の平滑化・統合。  
4. リアルタイム処理に配慮した**計算効率最適化**（ガウス混合モデル + 枝刈り/マージングなど）。

---

## 4. 発明の概要

**ONDE-SEVEN**（ONline Dynamic rEjection-SEVEN）検出器は、音声波形を短時間フーリエ変換（または任意の周波数解析手法）によって得られた**スペクトルピーク情報**を観測とみなし、**PHDフィルタ**を用いて以下を実現する:

1. **RFSフレームワーク**  
   - 各フレームで観測されるピーク群を「確率的に存在する音の候補」として取り扱う。  
   - 状態ベクトルを \([f, a]\)（周波数と振幅）などと定義し、複数音が同時に存在する可能性をガウス混合モデルで表現。

2. **PHDフィルタ**  
   - **生存確率** \( p_{\mathrm{survival}} \) により、前フレームの音が次フレームまで存続する確率をモデル化。  
   - **誕生モデル**（birth model）により、新規オンセット音の確率分布を生成。  
   - **観測モデル**により、実際のスペクトルピークをパラメータ（周波数／振幅）で観測し、不確実性を**観測ノイズ共分散**でモデル化。  
   - **クラッター強度**により、背景ノイズや誤ピークを扱う。  
   - これらを統合し、**Gaussian Mixture**として管理することで、マルチピッチを効率的に追跡。

3. **枝刈りとマージング**  
   - ガウス混合成分数が増大しないよう、**枝刈り（pruning）** や**マージング（merging）** を施す。  
   - 重みの小さい成分や位置が近い成分を統合し、最大コンポーネント数を制限。

4. **オンセット／オフセット検出**  
   - ガウス成分の出現を**新たな音の誕生（オンセット）**、  
   - 成分の重みが消失していく過程を**音の終了（オフセット）**とみなす。  
   - フレーム時刻と組み合わせて**音符区間**を生成。

5. **マルチピッチ出力**  
   - 一定の**抽出閾値**を超えるガウス成分をピッチ候補として出力。  
   - 周波数帯域 \([\mathrm{min\_f0}, \mathrm{max\_f0}]\) 内の成分のみを有効とすることで楽音への集中度を高める。

---

## 5. アルゴリズム構成

### 5.1 全体フローチャート

```
┌──────────────────────────────────────────┐
│ 1. 入力音声: time-domain samples                                     │
└──────────────────────────────────────────┘
                ▼
┌──────────────────────────────────────────┐
│ 2. 周波数分析 (STFT など)                                                  │
│    → フレームごとに amplitude spectrum を取得                          │
└──────────────────────────────────────────┘
                ▼
┌──────────────────────────────────────────┐
│ 3. ピーク検出 (PeakDetector)                                               │
│    → 各フレームで周波数ピーク [f, amp] のリストを観測として生成         │
└──────────────────────────────────────────┘
                ▼
┌──────────────────────────────────────────┐
│ 4. PHDフィルタ (OnlinePHDFilter)                                          │
│    4.1 予測 (Predict): 状態遷移 + 生存確率 p_survival                    │
│    4.2 誕生 (Add Birth): 新規観測に基づく birth model                   │
│    4.3 更新 (Update): 観測と尤度計算 + clutter_intensity + p_detection  │
│    4.4 枝刈り・マージング (Prune & Merge)                                 │
└──────────────────────────────────────────┘
                ▼
┌──────────────────────────────────────────┐
│ 5. 状態抽出 & 閾値処理: マルチピッチ [f1, f2, ...] を算出                │
│    → 各成分の weight が閾値を超過                                        │
└──────────────────────────────────────────┘
                ▼
┌──────────────────────────────────────────┐
│ 6. オンセット/オフセット判定 & ノート区間化                               │
│    → 新規成分の出現 = オンセット, 成分消失 = オフセット                   │
└──────────────────────────────────────────┘
                ▼
┌──────────────────────────────────────────┐
│ 7. 出力:                                                                        │
│     - note intervals, note pitches, frame-based pitch list, etc.              │
└──────────────────────────────────────────┘
```

---

## 6. 実装の詳細

### 6.1 **PeakDetector**
- 周波数範囲 \([\mathrm{min\_f0}, \mathrm{max\_f0}]\) を絞り込み、スペクトラムの局所ピークを検出。  
- ピークの振幅が全体最大値に対して \(\mathrm{peak\_threshold}\) 比以上の場合に観測として採用。

### 6.2 **OnlinePHDFilter**
- **状態ベクトル**: \(\mathbf{x} = [f, a]^T\) （周波数 \(f\), 振幅 \(a\)）  
- **観測ベクトル**: 同じく \(\mathbf{z} = [f, a]^T\)
- **プロセスモデル**: 短時間での周波数変動を小さく仮定し、恒等または緩やかな周波数変化モデルとする（例：\(\mathbf{x}_{k+1} = \mathbf{x}_k + \mathcal{N}(0, Q)\)）。  
- **観測モデル**: \(\mathbf{z}_k = \mathbf{x}_k + \mathcal{N}(0, R)\)

#### (1) 予測 (Predict)
- 全てのガウス成分\(\{ w_i, \mathbf{m}_i, P_i \}\)について、生存確率 \(p_{\mathrm{survival}}\) とプロセスノイズ \(Q\) を用いて:
  \[
    w_i^{(pred)} = p_{\mathrm{survival}} \cdot w_i, 
    \quad
    \mathbf{m}_i^{(pred)} = \mathbf{m}_i, 
    \quad
    P_i^{(pred)} = P_i + Q.
  \]
- 以後、誕生成分 \(\{w_j^{(birth)}, \mathbf{m}_j^{(birth)}, P_j^{(birth)}\}\) を合流させる。

#### (2) 観測 (Update)
- クラッターモデルとして、クラッター強度 \(\kappa\) を仮定。
- 観測 \(\mathbf{z}\) ごとに、各成分からの尤度 \(\ell_i(\mathbf{z})\) を計算し、重みを修正:
  \[
    w_i^{(upd)}(\mathbf{z}) = w_i^{(pred)} \cdot p_{\mathrm{detection}} \cdot \ell_i(\mathbf{z}) / \bigl(\kappa + \sum_i w_i^{(pred)} \ell_i(\mathbf{z})\bigr).
  \]
- 非検出成分は \( w_i^{(miss)} = w_i^{(pred)} (1 - p_{\mathrm{detection}})\) として更新。

#### (3) 枝刈り・マージング (Prune & Merge)
- **枝刈り**: 重みが閾値未満の成分を削除。  
- **マージング**: 近い平均を持つ成分（マハラノビス距離等で閾値内）の重み付き平均をとり、一つの成分にまとめる。  
- **上限成分数**: 最終的に最大 \(\mathrm{max\_components}\) を超えないようカット。

### 6.3 **ONDESEVENDetector**
- STFT等でフレーム分割 -> ピーク検出 -> PHDフィルタに入力 -> 抽出されたガウス成分から有効周波数（ピッチ）を抽出 -> オンセット／オフセット判定を行う。  
- `detect(...)` メソッドで連続フレーム処理を実現し、ノート区間およびピッチ列を出力。

---

## 7. 従来技術との差異・優位性

1. **マルチターゲット追跡フレームワーク**:  
   従来のスペクトルピーク検出 + フレーム独立の手法と異なり、RFS理論を導入することで**同時発音数の変動**や**クラッタ**を明示的に扱える。  

2. **誕生／消失の自然なモデリング**:  
   **誕生成分**を追加することで新たな音のオンセットを確率的に受容し、消失（オフセット）は重みの低下として滑らかに表現。  

3. **ガウス混合モデルの効率**:  
   部分音単位など複雑なテンプレートを用いず、**ピッチ軸+振幅軸**というシンプルな状態空間で追跡が可能。  
   剪定（pruning）と統合（merging）により計算コストを抑制。

4. **リアルタイム応用**:  
   軽量なガウス混合ベースの更新処理が中心であり、最適化やGPU実装も視野に入れることで**リアルタイム処理**が可能。

---

## 8. 実施例（Pythonコード概要）

```python
class ONDESEVENDetector(BaseDetector):
    def __init__(...):
        # 1. PHDフィルタ初期化 (OnlinePHDFilter)
        # 2. PeakDetector初期化
        # 3. 初期パラメータ設定 (p_survival, p_detection, clutter_intensity等)

    def detect(self, audio_data: np.ndarray, sr: int) -> Dict[str, Any]:
        # (A) フレームごとにSTFTやFFTでスペクトルを取得
        # (B) PeakDetectorでピークリストを観測として生成
        # (C) PHDフィルタ:
        #    1. predict()
        #    2. add_birth_components(peaks)
        #    3. update(peaks)
        # (D) extract_states() でピッチ候補取得
        # (E) オンセット/オフセット判定をフレーム単位で管理
        # (F) intervals & note_pitches を組み立てて出力

    def process_frame(self, audio_buffer):
        # 1. FFT等の周波数解析
        # 2. ピーク検出
        # 3. PHDの predict -> birth -> update
        # 4. 状態抽出

    # そのほか detect_notes(), detect_onsets(), detect_offsets() 等の補助メソッド
```

---

## 9. 効果・応用範囲

- **ポリフォニック音源**に対して、混在する複数ピッチを同時推定。  
- **ノート（区間、音高）の自動抽出**: オンセット／オフセット情報を確率的に補強するため、滑らかなアタックやノイズが多い環境でも高精度に検出可能。  
- **動的BGM解析・リアルタイム演奏追跡**: RFS理論による動的モデルを採用しているため、フレーム間で突発的に出現する音を捉えやすい。  
- **大規模音楽アーカイブの自動採譜**、**MIDI変換**、**ライブ演奏のモニタリング**など、多岐にわたる応用が期待される。

---

## 10. 産業上の利用可能性

- **楽曲制作支援ツール**: DAW（Digital Audio Workstation）ソフトや譜面生成システムに組み込むことで、複雑な録音源からピッチを可視化・編集。  
- **ライブ演奏解析**: 演奏中の複数パートをリアルタイムで分離・可視化し、ハーモニーやミス検出を行う。  
- **音楽学習支援**: 複数音が混じる合奏でも各パートの音高をモニタリングし、学習者へ適切なフィードバックを提供。  
- **映像やゲーム分野**: 効果音の中に含まれる音楽ピッチを動的にトラッキングし、VR/ARアプリケーションのBGM制御に応用。

---

## 11. 従来技術との比較表（例）

| 項目                        | 従来 (複数ピーク単独) | 本手法 (ONDE-SEVEN)                     |
|---------------------------|-------------------|-------------------------------------|
| 同時発音 (ポリフォニック)      | 誤検出や重複が多い       | RFSベースで自然に複数音を追跡              |
| ノイズ・クラッタ処理           | しきい値調整に依存        | clutter_intensity パラメータで確率的に扱う |
| オンセット/オフセット検出精度 | エネルギー閾値に依存       | PHDの生存/誕生確率モデルにより安定         |
| リアルタイム性                 | フレームごとの処理        | フィルタ更新ベースで効率的              |
| 実装の複雑度                 | 中程度                | 高め (RFS理論+GMM管理)                |
| 応用範囲                    | 単純ポリフォニー           | 複雑ポリフォニー+ノイズ混在             |

---

## 12. 特許請求の範囲（例示）

**請求項1**  
音声信号をフレームごとに周波数スペクトルへ変換し、ピーク検出を行う工程と、該ピーク群を観測として確率密度関数をガウス混合モデルで表現し、Random Finite Set理論に基づくPHD（Probability Hypothesis Density）フィルタを用いて前記ピーク群を追跡する工程と、フレーム間の生存確率および誕生モデルを用いて新規音のオンセットおよび既存音のオフセットを推定する工程とを備えることを特徴とするマルチピッチ検出方法。

**請求項2**  
請求項1において、クラッタ密度を定めることによりノイズピークを確率的にモデル化し、ガウス混合成分の枝刈りおよびマージングにより成分数を制御することを特徴とするマルチピッチ検出方法。

**請求項3**  
請求項1または2において、抽出されたガウス成分の重みが所定閾値を超えるとき、その周波数成分を検出された音として評価し、複数の周波数成分を同時に取得することを特徴とするマルチターゲット追跡方法。

---

## 13. まとめ

**ONDE-SEVEN**は、**RFS/PHDフィルタ**の枠組みを音楽信号解析に導入し、**複数同時ピッチの推定**および**オンセット／オフセット検出**を一元的に行う革新的手法である。  
- 確率的フレームワークにより、従来の閾値設定に頼らない強固なモデル化が可能  
- 観測数や同時発音数が変動する環境下でも頑健に動作  
- ポリフォニックな楽器演奏や雑音混在条件下での自動採譜などに有用

本手法は従来方式では扱いづらかった**多音＆ノイズ環境**を統計的に整理し、リアルタイム処理に適した軽量ガウス混合モデルを適用することで、音楽情報処理における新たなアプローチを提供する。さらに、オンセット・オフセット・ピッチ情報を直接抽出可能であり、応用範囲も広範である。

以上が本アルゴリズム仕様書（論文レベル）の要旨である。特許出願や論文投稿時には、実測データとの比較実験結果やパラメータチューニング戦略、実装の最適化手法などを付記することで、より詳細なエビデンスを補強できる。