## FAZΞ-CN: 自己微分積と曲率エントロピーに基づく統合的音響イベント検出アルゴリズム

**要約**

本稿では、音響信号からオンセット、オフセット、ピッチ、音量といった基本的な音楽情報を抽出し、さらに信号の周期的/非周期的特性を識別するための新しいアルゴリズム「FAZΞ-CN (Frequency Amplitude Z-domain Extraction with Curvature Nonperiodicity)」を提案する。本アルゴリズムの核心は、(1) 定Q複素共振フィルタバンクを用いて信号を時間-周波数領域の複素包絡 \(z_b[n]\) へと分解し、(2) この複素包絡とその時間微分から計算される「自己微分積」Ξ (\(z_b^* \cdot \dot{z}_b\)) を導入して、その実部からオンセット/オフセットを、虚部からピッチ情報を効率的に推定すること、そして (3) 複素包絡が時間-周波数平面上で描く軌跡の「曲率エントロピー」NP を計算し、信号の非周期性（ノイズや打楽器音らしさ）を定量化することにある。これらの独自指標 Ξ と NP を統合することで、FAZΞ-CNは単一のフレームワーク内で音響イベントのタイミング、ピッチ、音量、および音響的性質（調性的か非調性的か）の同時推定を可能にする。

**1. はじめに**

音響信号からの主要な特徴量抽出（オンセット、オフセット、ピッチ、音量など）は、音楽情報検索、自動採譜、音声分析といった分野における基礎的かつ重要な課題である。従来の多くの手法は、時間領域または周波数領域のいずれか一方の分析に偏るか、あるいは両者を組み合わせる場合でも、オンセット検出とピッチ推定を独立したモジュールとして処理することが多かった。これにより、突発的なノイズによる誤検出、多音環境でのピッチ推定精度の低下、非周期的な音（打楽器音など）と周期的な楽音の識別の困難さといった問題が生じていた。

FAZΞ-CNアルゴリズムは、これらの課題に対し、複素信号処理と統計的特徴量に基づく新しいアプローチを提案する。まず、人間の聴覚特性に近い対数的な周波数分解能を持つ定Q複素共振フィルタバンクを用いて、入力信号を複数の帯域における複素包絡 \(z_b[n] = y_b^{\text{(cos)}}[n] + j \cdot y_b^{\text{(sin)}}[n]\) へと変換する。この複素包絡の時間変化を捉えるために、独自の指標である「自己微分積」Ξ を導入する。

\[ \Xi_b[n] = z_b^*[n] \cdot \dot{z}_b[n] = z_b^*[n] \cdot (z_b[n] - z_b[n-1]) \]

Ξの実部はエネルギー流束の変化率に、虚部は振幅で重み付けされた瞬時角周波数にそれぞれ関連しており、これを全バンドで合算することで、オンセット/オフセット検出とピッチ推定の双方に有用な情報を単一の計算から得ることができる。

さらに、音の質感を評価するために、複素包絡が時間-周波数平面上で描く軌跡の幾何学的特性に着目する。軌跡の「曲率」\(\kappa_b[n]\) を計算し、そのフレーム内での統計的分布（ヒストグラム）からシャノンエントロピーを算出する。これをエネルギーで加重平均したものが「曲率エントロピー（非周期性指標）」NP であり、信号が周期的（NP小）か非周期的（NP大）かを定量化する。

FAZΞ-CNは、これら自己微分積 Ξ と曲率エントロピー NP を統合利用することで、オンセット/オフセットのタイミング、ピッチ、音量、そして非周期性という複数の音響特徴を、相互に関連付けながら効率的に抽出することを目指す。

**2. アルゴリズム詳細**

**2.1 定Q複素共振フィルタバンク**

アルゴリズムの第一段階として、入力信号 \(x[n]\) を複数の周波数帯域に分解する。人間の聴覚特性に倣い、対数的な周波数分解能を持つ定Qフィルタバンクを採用する。

*   **バンド定義:** 中心周波数 \(f_b = f_{\min} \times 2^{(b-1)/\beta}\) (\(b=1,...,B\))、オクターブあたりバンド数 \(\beta\)、品質係数 \(Q\) を用いてバンドを定義する。
*   **フィルタ実装:** 計算効率と安定性を考慮し、直接離散時間極方式に基づく2次のIIRフィルタとして実装する。各バンド \(b\) について、実部出力 \(y_b^{\text{(cos)}}[n]\) と虚部出力 \(y_b^{\text{(sin)}}[n]\) を得る独立したフィルタ対を設計する（`_design_filterbank`, `_apply_complex_filters`）。
    *   極: \(\rho_b = e^{-\alpha_b T}, \theta_b = \omega_{b,0}T\sqrt{1-1/(4Q^2)}\) （\(\alpha_b = \omega_{b,0}/(2Q)\), \(T=1/f_s\)）
    *   係数 \(a_{b,1}, a_{b,2}\) (共通), \(b_{b,k}^{\text{(cos)}}, b_{b,k}^{\text{(sin)}}\) を計算。
*   **複素包絡:** 各バンドの出力を合成して複素包絡 \(z_b[n] = y_b^{\text{(cos)}}[n] + j \cdot y_b^{\text{(sin)}}[n]\) を得る。その振幅は \(r_b[n] = |z_b[n]|\) である。

**2.2 自己微分積 (Ξ) の計算**

複素包絡 \(z_b[n]\) の時間的な変化を捉えるため、自己微分積 Ξ を計算する。

*   **離散微分:** \(\dot{z}_b[n] = z_b[n] - z_b[n-1]\)
*   **自己微分積:** \(\Xi_b[n] = z_b^*[n] \cdot \dot{z}_b[n]\)
*   **全バンド合算:** \(\Xi[n] = \sum_{b=1}^B \Xi_b[n]\)
*   **フレーム化:** 後の処理のため、\(\Xi[n]\) をフレーム長 \(N_f\)、ホップ長 \(H\) で区切り、各フレーム \(m\) における実部と虚部の合計値を計算する (`_process_frames`)。
    *   実部合計: \(\mathcal{O}[m] = \sum_{n=mH}^{mH+N_f-1} \text{Re}[\Xi[n]]\) （オンセット/オフセット指標）
    *   虚部合計: \(\mathcal{I}[m] = \sum_{n=mH}^{mH+N_f-1} \text{Im}[\Xi[n]]\) （ピッチ推定用）

**2.3 曲率エントロピー (非周期性指標 NP) の計算**

信号の周期的/非周期的特性を評価するため、複素包絡の軌跡の曲率に基づくエントロピーを計算する。

*   **曲率計算 (`_calculate_curvature`):** 各バンド \(b\) の複素包絡 \(z_b[n]\) を2次元ベクトル \(\mathbf{x}_b[n] = (y_b^{\text{(cos)}}[n], y_b^{\text{(sin)}}[n])\) とみなし、その軌跡の曲率 \(\kappa_b[n]\) を離散微分（1階 \(\dot{\mathbf{x}}_b\)、2階 \(\ddot{\mathbf{x}}_b\)）を用いて計算する。
    \[ \kappa_b[n] = \frac{|\dot{\mathbf{x}}_b[n] \times \ddot{\mathbf{x}}_b[n]|}{||\dot{\mathbf{x}}_b[n]||^3} \]
    ここで \(\times\) は2次元の外積（スカラー値）、\(||\cdot||\) はユークリッドノルムである。数値安定化のため、分母がゼロに近い場合は \(\kappa_b[n]=0\) とする。
*   **フレーム内エントロピー計算 (`_calculate_entropy`):** フレーム \(m\) 内の各バンド \(b\) について、曲率値 \(\kappa_b[n]\) の分布（ヒストグラム）を作成し、そのシャノンエントロピー \(H_{\kappa,b}[m]\) を計算する。
*   **非周期性指標 (NP) の計算:** 各バンドのエントロピーを、そのフレームにおけるバンドのエネルギー \(r_b^2[m]\) で重み付け平均し、非周期性指標 \(NP[m]\) を得る。
    \[ NP[m] = \frac{\sum_{b=1}^B r_b^2[m] \cdot H_{\kappa,b}[m]}{\sum_{b=1}^B r_b^2[m]} \]
    NP は 0 (完全周期的) から 1 (ノイズ的) の範囲に正規化される（実際のエントロピーの上限による）。NP が高いほど、信号は非周期的（ノイズや打楽器音に近い）と解釈できる。

**2.4 オンセット・オフセット検出 (`_detect_onsets_offsets`)**

自己微分積の実部合計 \(\mathcal{O}[m]\) の時間変化を利用してオンセットとオフセットを検出する。

*   **動的閾値:** \(\mathcal{O}[m]\) の直近 \(M\) フレームにおける移動平均 \(\mu_{\mathcal{O}}[m]\) と移動標準偏差 \(\sigma_{\mathcal{O}}[m]\) を計算する。
*   オンセット閾値 \(\theta_{\text{on}}[m] = \mu_{\mathcal{O}}[m] + k_{\text{on}} \cdot \sigma_{\mathcal{O}}[m]\)
*   オフセット閾値 \(\theta_{\text{off}}[m] = \mu_{\mathcal{O}}[m] - k_{\text{off}} \cdot \sigma_{\mathcal{O}}[m]\)
*   **ピーク検出:** \(\mathcal{O}[m]\) が \(\theta_{\text{on}}[m]\) を超え、かつ局所的なピークであればオンセット候補とする。
*   **ヒステリシス:** 閾値 \(\theta_{\text{off}}[m]\) を下回る状態が \(C\) フレーム連続した場合にオフセットと判定する。
*   **ノートフィルタリング:** 検出されたオンセット・オフセット対のうち、持続時間が `min_note_length` 未満のものは除去する。

**2.5 ピッチ推定 (`_estimate_pitches`)**

自己微分積の虚部合計 \(\mathcal{I}[m]\) とフレームエネルギー \(E[m] = \sum_b r_b^2[m]\) を用いてピッチを推定する。

*   **加重平均角周波数:** \(\omega_{\text{avg}}[m] = \mathcal{I}[m] / E[m]\)
*   **ピッチ周波数:** \(f_{\text{pitch}}[m] = \frac{f_s}{2\pi} |\omega_{\text{avg}}[m]|\)
*   **有効性判定:** フレーム \(m\) の非周期性指標 \(NP[m]\) が閾値 \(\theta_{NP}\) を超える場合、またはエネルギー \(E[m]\) が極端に小さい場合は、ピッチ推定値を無効（0 Hz）とする。
*   **後処理:** 推定されたピッチ系列に対して、範囲外の値の除去やメディアンフィルタによる平滑化を行う。

**2.6 音量計算**

各フレーム \(m\) における音量 \(V[m]\) は、全バンドのエネルギー合計 \(E[m]\) として計算される。オプションで対数スケール \(L[m] = 10\log_{10}(\epsilon + E[m])\) に変換することも可能。

**3. 実装とパラメータ**

実装は `FAZEDetector` クラスで行われ、主要なパラメータ（バンド数 `bands`, 最低周波数 `f_min`, オクターブあたりバンド数 `beta`, Q値 `q_factor`, フレーム長 `frame_length`, ホップ長 `hop_length` など）はコンストラクタで設定可能である。特に `q_factor`, `onset_threshold_factor`, `offset_threshold_factor`, `nonperiodicity_threshold` が検出性能に影響を与える。フィルタバンクの設計には数値安定性の考慮が必要である。

**4. 新規性と利点**

FAZΞ-CNアルゴリズムの新規性は、以下の点にある。

*   **自己微分積 (Ξ) の導入:** 複素共振フィルタバンク出力に対して定義されるこの新しい指標は、単一の計算からオンセット/オフセット検出（実部）とピッチ推定（虚部）に直接関連する情報を抽出できる。これは、従来のエネルギー差分や位相差分に基づく手法とは異なるアプローチである。
*   **曲率エントロピー (NP) の導入:** 複素包絡の軌跡の幾何学的特性（曲率）とその統計量（エントロピー）を用いて、信号の非周期性を定量化する独自の指標である。これにより、打楽器音やノイズなど非調性的な音響イベントの客観的な評価と識別が可能になる。
*   **Ξ と NP の統合:** 自己微分積によるイベントタイミング・ピッチ情報と、曲率エントロピーによる周期性情報を組み合わせることで、イベントの検出とその性質（周期的/非周期的）の分類、およびピッチ推定の信頼性評価を単一のアルゴリズム内で実現している点。

これらの独自性により、FAZΞ-CNは以下の利点を提供する。

*   オンセット、オフセット、ピッチ、音量、非周期性という複数の音響特徴を同時に、統一的な枠組みで抽出できる。
*   自己微分積により、エネルギー変化だけでなく位相変化にも敏感なオンセット/オフセット検出が可能。
*   曲率エントロピーにより、楽音と打楽器音・ノイズを客観的に区別できる。
*   定Qフィルタバンクにより、対数的な周波数知覚特性に近い分析が可能。

**5. 結論**

FAZΞ-CNアルゴリズムは、定Q複素共振フィルタバンク、自己微分積（Ξ）、曲率エントロピー（NP）という独自の要素技術を組み合わせた新しい音響イベント検出手法である。Ξ はイベントタイミングとピッチ情報、NP は信号の周期性/非周期性を捉える独自の指標であり、これらを統合することで、音響信号の多面的な特徴量を効率的かつ高精度に抽出することが可能となる。本手法は、自動採譜、音源分離、音響シーン分析など、幅広い応用分野への貢献が期待される。
