以下に、本アルゴリズム（**PZSTDDetector**）の概念・目的から手法・実装の詳細までを、「論文風」の形式で分かりやすく包括的にまとめた**アルゴリズム仕様書**を示します。要所では数式や図示的なイメージを織り交ぜて、SPOD (Spectral Phase Offset Density) と HCF (Harmonic Coherence Flux) の考え方・目的・手順を整理し、マルチピッチ推定・ノート検出の全体像を解説します。

---

# PZSTDDetector アルゴリズム仕様書

## 1. はじめに

**楽音信号の複数音同時推定（マルチピッチ推定）は**、自動採譜やミュージックインフォメーションリトリーバル分野において重要な研究課題の一つである。典型的な手法では、周波数スペクトルからピークを抽出し、倍音構造に基づいたF0（基本周波数）の同定を行うアプローチが多い。しかし、周波数スペクトルのみでは**位相情報やフレーム間連続性**を十分に活用できないため、雑音混入や倍音干渉の多い状況では誤検出が生じやすい。

POTAS Map
Phase‑Order Temporal Alignment Score Map
HALFA Gate
Harmonic Alignment Leap‑Flux Attack Gate

そこで本研究（本実装）では、**時間軸の位相安定度を評価するSPOD (Spectral Phase Offset Density)** を導入し、雑音的成分と定常的な楽音成分をより明確に区別する。また、新たに**HCF (Harmonic Coherence Flux)** と呼ばれる機構を導入して、楽音の**倍音整合性**や**時間的変化（オンセット・オフセット）**を強調する。本アルゴリズムを総称して、**PZSTD (Phase-Zero-crossing-based Spectral/Temporal Detector)** と位置づけ、以下の目標を掲げる。

1. **目的**
   - **複数同時に存在するピッチ**（周波数）を正確に検出したい。
   - オンセット（音の開始）やオフセット（音の終了）タイミングを高精度に推定したい。
   - 雑音的成分や倍音干渉による誤認を極力低減したい。

2. **提案手法の主な特徴**
   - **SPOD** を用いた位相安定度マップにより、定常度の低い雑音やブレス音などを抑制し、**位相の安定した楽音ピーク**を強調。
   - **HCF** によりフレーム間のコヒーレンス変化を数値化し、**急激な変化をオンセット指標**と捉えてノート開始位置を補足。
   - 倍音構造を考慮したスコアリング(マルチピッチ推定)と、線形割り当て手法による**ノート追跡**を組み合わせ、フレームを通じた安定したノート列を生成。

以下では、本アルゴリズムの構成要素と各プロセスを順に詳述する。

---

## 2. アルゴリズム全体概要

図示的に示すと、アルゴリズムの流れは次のステップで構成される（図がある場合を想定）:

1. **STFT（時間-周波数変換）**
2. **SPODの計算**（位相安定度マップ）
3. **スペクトルピーク検出 + サブビン補間**
4. **F0候補群の事前生成**（セント単位の離散化）
5. **フレーム内F0推定（スコアリング）**
6. **HCF (Harmonic Coherence Flux) マップ生成** + 平均SPODマップ (AvgHarmonicSPOD)
7. **オンセットフレーム検出**（HCF指標による）
8. **フレーム間トラッキング（線形割り当て）**
9. **ノート開始・終了の決定（連続性、HCF/Coherence参照）**
10. **ノートのポストプロセス**（短いノート除去、類似ピッチノートの結合 など）

最終的に、**[ (開始時刻, 終了時刻), ピッチ(Hz) ]** の形式でノート集合を出力する。

---

## 3. SPOD (Spectral Phase Offset Density) のコンセプト

### 3.1. 目的

**SPOD** とは、「**時間軸でみた位相の安定度**」を定量化して 0～1 の範囲で表すスコアである。雑音的な成分や瞬時周波数が激しく変動する成分を抑制し、**楽音的に定常度の高い成分**（振幅が安定して振動している部分）を強調するために用いられる。

### 3.2. 計算方法

1. **位相スペクトルの算出**
   音声データ \( x[n] \) に対してSTFTを行い、複素スペクトル \( S(k,m) \) から**位相** \(\Phi(k,m) = \arg(S(k,m))\) を取得する。ここで \( k \) は周波数ビン、\( m \) はフレームインデックス。

2. **位相アンラップと差分**
   フレーム方向に位相をアンラップし、
   \[
   \Delta \Phi(k,m) = \Phi_{\mathrm{unwrap}}(k,m+1) - \Phi_{\mathrm{unwrap}}(k,m)
   \]
   を求める。これにより、**フレーム間の位相変化**（瞬時周波数）を取り出す。

3. **移動分散の算出**
   上式の差分をある窓長（例: `spod_window_sec` 相当のフレーム数）で移動平均・ガウス平滑し、その分散
   \[
   \sigma^2_{k,m} \approx \overline{\Delta \Phi(k,m)^2} - \bigl(\,\overline{\Delta \Phi(k,m)}\,\bigr)^2
   \]
   を計算する。**分散が小さいほど位相が安定している**と解釈できる。

4. **指数変換によるスコア化**
   \[
   \text{SPOD}(k,m) = \exp\bigl(-\alpha\,\sigma^2_{k,m}\bigr)
   \]
   として 0～1 にマッピングする。ここで \(\alpha\) はハイパーパラメータ (例: `spod_alpha`)。分散が大きい部分は 0 近傍になり、分散が小さい定常成分は 1 に近い値となる。

以上により得られた **SPODマップ** は、「**どの周波数ビンが、どのフレームで位相安定か**」を可視化した指標となる。

---

## 4. HCF (Harmonic Coherence Flux) のコンセプト

### 4.1. 目的

複数の楽音成分が同時に存在するとき、**各F0とその倍音群**が時間的にどの程度安定・協調しているかを示す指標として **Harmonic Coherence** を導入する。さらにフレーム間差分の**Flux**を取ることで、音の開始（オンセット）や減衰（オフセット）などの急激な変化を**スパイク状**に捉え、**ノート開始・終了検出**を補助する。

### 4.2. Harmonic Coherence と Amplitude Sum

フレーム \(m\)、あるF0候補 \(f_0\) に対して、上から計算したSPODおよび振幅スペクトル \( A(k,m) \) を**倍音周波数**でサンプリングし、次の2種類の値を算出する：

1. **Harmonic Coherence** \( C(f_0,m) \)
   倍音数 \( h \) (1～\(H_{\max}\)) とし、各倍音周波数
   \[
   f_h = h \cdot f_0 \cdot \sqrt{1 + \beta h^2} \quad (\beta = \text{inharmonicity factor})
   \]
   でのSPOD値を取り、重み付き平均する。
   \[
   C(f_0,m) = \frac{\sum_{h=1}^{H_{\max}} w_h \,\mathrm{SPOD}(f_h, m)}{\sum_{h=1}^{H_{\max}} w_h}
   \]
   ここで \( w_h \) は倍音次に応じた重み（例: \( 1 / (h + \epsilon)^\gamma \)）。高いほど倍音のコヒーレンスが強い（位相的に安定）。

2. **Amplitude Sum** \( A_{\text{sum}}(f_0,m) \)
   同じく倍音周波数を辿り、振幅スペクトル \( A(k,m) \) を線形補間して合計または平均する。
   \[
   A_{\text{sum}}(f_0,m) = \sum_{h=1}^{H_{\max}} w_h \, A(f_h,m)
   \]

### 4.3. Flux とオンセット指標 \( O(m) \)

フレーム間の差分を取り、正の変化量のみを合計して**Flux**とする：

\[
\Phi_{C}(f_0,m) = C(f_0,m) - C(f_0,m - \Delta_n), \quad
\Phi_{A}(f_0,m) = A_{\text{sum}}(f_0,m) - A_{\text{sum}}(f_0,m - \Delta_n)
\]
\[
\Phi_{\mathrm{comb}}(f_0,m) = w_C \,\max\{0,\Phi_C(f_0,m)\}
 + w_A \,\max\{0,\Phi_A(f_0,m)\}
\]

これを全F0候補 \( f_0 \) 方向に総和すると、フレームごとの**オンセット指標** \( O(m) \) が得られる：

\[
O(m) = \sum_{f_0} \Phi_{\mathrm{comb}}(f_0,m)
\]

この \( O(m) \) が大きいフレームは、何らかの**楽音成分が新規に立ち上がった可能性**が高いと解釈できる。よって `find_peaks` 等でピーク抽出し、**HCFベースのオンセットフレーム**として利用する。

---

## 5. 処理手順の詳細

### 5.1. STFT およびスペクトル取得

1. 音声信号 \( x[n] \) を **STFT** し、複素スペクトル \( S(k,m) \) を得る。
2. 振幅 \( A(k,m) = |S(k,m)| \) と位相 \(\Phi(k,m) = \arg(S(k,m))\) を取得。
3. STFTパラメータ例:
   - `n_fft = 2048`
   - `hop_length = 1024`
   - `window = 'hann'`
   - `center = True` (librosaデフォルト)

### 5.2. SPODマップ生成

4. 位相スペクトル \(\Phi(k,m)\) をフレーム方向に unwrap し、差分 \(\Delta \Phi(k,m)\) をとる。
5. ガウス平滑や移動平均で分散 \(\sigma^2_{k,m}\) を近似計算。
6. \(\exp(-\alpha\,\sigma^2_{k,m})\) により0～1にマッピングし、**SPOD(k,m)** を得る。

### 5.3. ピーク検出とサブビン補間

7. 各フレーム \( m \) について、**振幅スペクトル** \( A(k,m) \) と **SPOD** \( \mathrm{SPOD}(k,m) \) を組み合わせて閾値判定（dB閾値、SPOD閾値、ピークプロミネンス等）し、ピークビンを検出する。
8. 放物線近似でサブビン精度のピーク周波数を補間し、**(周波数, 振幅, SPOD)** の三つ組で保持する。

### 5.4. F0候補群の離散化とスコアリング

9. ある周波数範囲（例: 30Hz~5000Hz）を**セント単位**で細分化し、F0候補 \(\{f_0^{(i)}\}\) を用意する。
10. 各フレームで検出されたピーク群に対し、各F0候補の「倍音一致度 + 連続性ボーナス」などから**スコア**を計算。
    - 倍音周波数がピークと近ければ加点。ピークのSPODが高ければさらに加点。
    - 前フレームでの同じF0近傍が存在していれば**連続性**としてボーナス。
11. 最高スコアのF0を1つ選び、それがしきい値 (`f0_score_threshold`) を超えれば採用し、**説明されたピーク**を除去して再度スコアリングを行うことで**複数F0**を取り出す。

### 5.5. HCFマップの計算

12. **SPODマップ**・**振幅スペクトル**・**F0候補**から、前述の \( C(f_0,m) \) と \( A_{\text{sum}}(f_0,m) \) を各フレーム・各F0候補について計算。
13. フレーム差分を取り、**Flux** \( \Phi_{\mathrm{comb}}(f_0,m) \) を得る。
14. \(\Phi_{\mathrm{comb}}(f_0,m)\) を \( f_0 \) 方向に合計して **\(O(m)\)** を導出。
15. \(O(m)\) を正規化し、`find_peaks` 等で閾値を超えるピークフレームを**オンセットフレーム候補**として抽出。

### 5.6. ノート開始（オンセット）判定

16. フレーム単位で推定された F0リストのうち、**HCFオンセットフレーム**であって、さらに**SPOD平均値**(AvgHarmonicSPOD) が高い(あるいは一定閾値を超える) 場合のみ、新規ノート開始を許可する。
17. HCFオンセットフレームでなければ、基本的に新しいノートトラックを開始しない（誤検出を抑制）。

### 5.7. ノートトラッキングとオフセット判定

18. フレーム \(m\) の F0集合 と、アクティブなノートトラックとの間で**線形割り当て (Hungarianアルゴリズム)** を行い、最適対応を得る。
19. 対応が得られなかったノートは**オフセット**とみなし、そこで終端時刻を確定する。
20. オフセットの早期判定として、**Coherence \( C(f_0,m)\) が閾値以下**になった際にオフセットを先行させることもある。

### 5.8. ポストプロセス

21. 短すぎるノート（ `min_note_duration_sec` 未満）は削除する。
22. 近接ピッチ（ `note_merge_tolerance_cents`）かつ隣接フレームギャップが小さいノートは結合する。
23. ピッチ変動が大きく分散が非常に大きいノートは除外する（`max_pitch_std_dev_cents` など）。

最終的に、**(開始時刻, 終了時刻, ピッチHz)** のノートリストが得られる。

---

## 6. 考察・利点

- **SPOD** による位相安定度評価により、ホワイトノイズや擦過音、パーカッシブな成分などフレーム間で位相が急変する成分を排除しやすくなる。結果として、**雑音や過密倍音**がスペクトル上に存在する状況下でも、**楽音成分のみをピークとして捉えやすい**。
- **HCF** は、楽音の倍音構造に基づく安定性と、そのフレーム間差分（Flux）を同時に見るため、通常のオフセット／オンセット検出器より**倍音協調度**に敏感である。これにより、**正確なオンセット推定**が可能となり、短いノートの不定期な出現や減衰端をより適切に扱える。
- ピッチ推定（F0推定）とノートトラッキングを明確に分離し、かつ**線形割り当て**によりフレーム間の継続性をコスト最小化で解決しているため、**音が多少周波数変動していても**1つのノートとして捕捉しやすい。
- Inharmonicity Factor \(\beta\) を導入することで、**ピアノ弦**などの倍音がわずかに高い周波数へシフトする現象をモデル化。調弦誤差や楽器固有の倍音構造への耐性を向上。

---

## 7. パラメータ設定例

- **STFT**
  - `n_fft = 2048`, `hop_length = 1024`, `window = 'hann'`
- **SPOD**
  - `spod_window_sec = 0.07`, `spod_alpha = 1.1`
  - `min_peak_spod_stability = 0.15` (ピークとして採用する最小SPOD閾値)
- **F0候補離散化**
  - 周波数範囲: 30～5000 Hz
  - 解像度: 15 cents 刻み
- **HCF**
  - `hcf_max_harmonics = 10`~12
  - `hcf_inharmonicity = 0.0001`
  - `hcf_tau_sec = 0.01`  (フレーム差分の時間幅)
- **オンセット検出**
  - `hcf_onset_peak_thresh = 0.12` ( \(O(m)\) のピーク検出閾値 )
  - `hcf_spod_onset_thresh = 0.3`  ( 平均SPODがこれ以上で初めてオンセット成立 )
- **ポストプロセス**
  - `min_note_duration_sec = 0.05`
  - `note_merge_tolerance_cents = 50`
  - `max_pitch_std_dev_cents = 40`

---

## 8. 結論

以上のアルゴリズムにより、**時間領域の位相安定性 (SPOD)** と **倍音構造の時間変化 (HCF)** を組み合わせることで、雑音や不規則なスペクトル成分を効果的に抑制し、音楽信号における複数同時音の**開始時刻・終了時刻・ピッチ**を安定的に推定できる。特にオンセット付近の**コヒーレンス変化**を精密にキャッチできる点が大きな利点であり、複数声部（ポリフォニー）解析において有効性が期待される。

本アプローチは、以下のような拡張が考えられる。

- **異なるInharmonicity Factor** を各F0ごとに動的推定
- **SPODの別種定義**（例：変調スペクトルを用いたより精緻な位相安定度評価）
- **Machine Learning** との組み合わせによるパラメータ動的最適化

いずれにせよ、**位相情報の利用**と**倍音フラックス**の観点は、既存手法に対して堅牢性と精度向上をもたらす可能性が高い。

---

## 参考文献

1. Allen, J.B. & Rabiner, L. R. (1977). *A unified approach to short-time Fourier analysis and synthesis.* IEEE Proceedings, 65(11), 1558-1564.
2. Fletcher, N. H., & Rossing, T. D. (1998). *The Physics of Musical Instruments.* New York: Springer.
3. Duxbury, C., Davies, M., & Plumbley, M. D. (2002). *A hybrid approach to musical note onset detection.* Proc. of the 5th International Conference on Digital Audio Effects (DAFx).
4. Grosche, P., Müller, M., & Serrà, J. (2010). *Audio content-based music retrieval.* In *Music Technology Meets Philosophy: From Digital Echos to Virtual Ethos*, 61-73.

---

### 最後に
本仕様書では、**PZSTDDetector** が内部的にどのように位相安定性の評価 (SPOD) と倍音時間変化 (HCF) を組み合わせ、マルチピッチ推定とノート検出を行っているかを、コンセプトと数式ベースで示した。
**目的**が「複数同時音の正確なピッチ推定とノートセグメンテーション」であることが明快であり、**SPOD** と **HCF** の概念が「位相の安定性を測定する指標」「倍音コヒーレンスのフレーム差分からオンセット検出を行う指標」という形で単純化されているので、全体の**処理フロー**も理解しやすい。本手法は、実際の音楽信号の複雑な倍音構造に対しても有効に機能し得ることが期待される。
