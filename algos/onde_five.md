## ONDE-FIVE: 時間領域と周波数領域の統合、および動的アンチパターン検出に基づく音響イベント検出アルゴリズム

**要約**

本稿では、音楽・音声信号からピッチ、オンセット、オフセットを単一の枠組みで高精度に検出するアルゴリズム「ONDE-FIVE」を提案する。本手法の核心は、時間領域での堅牢な周期性推定（自己相関）と周波数領域での倍音構造解析を相補的に利用し、これらを「動的アンチパターン検出」という概念の下で統合する点にある。動的アンチパターン検出は、多次元ガウス分布を用いたオンライン背景モデルに基づいており、信号の統計的特性の変化からイベントを捉えつつ、ノイズや非定常な妨害音（アンチパターン）の影響を適応的に抑制する。さらに、単一のメタパラメータ \(\theta\) を導入し、検出感度や時間スケールに関わる複数の内部パラメータを連動して制御することで、多様な音源や環境への適応性とユーザーによる調整の容易性を両立させた。実験により、本手法が特にノイズ環境下や音色変化に対して頑健であり、リアルタイム処理にも適した計算効率を持つことを示す。

**1. はじめに**

音響信号からのイベント検出（オンセット、オフセット）とピッチ推定は、音楽情報処理、音声認識、音響モニタリングなど多岐にわたる応用分野の基盤技術である。従来手法は、時間領域アプローチ（例: エネルギー変化、自己相関）と周波数領域アプローチ（例: スペクトル変化、高調波構造分析）に大別されるが、それぞれ長所と短所を持つ。時間領域手法は過渡現象（オンセット）の検出に優れる一方、ノイズや多音に弱い。周波数領域手法はピッチや音色の識別に優れるが、時間分解能に限界があり、非調波成分の影響を受けやすい。

これらの課題を克服するため、両領域の情報を統合する試みがなされてきたが、複雑な信号（多音、ノイズ、音色変化）に対する頑健性や、リアルタイム処理の要求を満たすことは依然として困難であった。特に、(1) 定常ノイズだけでなく突発的なノイズや非音楽的な音（アンチパターン）の扱い、(2) 異なる音響特性を持つイベント（例: 打楽器音と楽音）への統一的な対応、(3) 検出感度と安定性のバランス調整の難しさ、が問題となっていた。

本稿で提案するONDE-FIVEは、これらの課題に対する新しい解決策を提供する。核となるアイデアは以下の3点である。

1.  **時間-周波数統合特徴ベクトル:** 時間領域の周期性情報（ピッチ、確信度）と周波数領域の倍音構造情報（倍音整合度）などを組み合わせた多次元特徴ベクトルを用いる。
2.  **動的アンチパターン検出:** 多次元ガウス分布に基づくオンライン学習型の背景モデルを構築し、観測された特徴ベクトルがこの背景モデルからどの程度「逸脱」しているかをマハラノビス距離で評価する。これにより、定常的な背景だけでなく、統計的に予期されないパターン（アンチパターン）を検出し、その影響を抑制する。イベント状態に応じて背景モデルの更新速度を適応的に変化させることで、信号への追従とノイズ除去を両立する。
3.  **単一メタパラメータ \(\theta\) による統合制御:** 検出閾値、背景モデルの更新速度、イベント判定のヒステリシスなどを、単一の直感的なパラメータ \(\theta\) によって連動して制御する。これにより、ユーザーは感度と安定性のトレードオフを容易に調整できる。

本稿では、ONDE-FIVEの理論的背景、アルゴリズムの詳細な処理フロー、主要なパラメータとその役割について解説する。

**2. アルゴリズムの理論的背景と主要コンポーネント**

**2.1 時間領域ピッチ検出 (`TimeDomainPitchDetector`)**

信号の周期性を捉えるため、自己相関関数 (ACF) に基づくピッチ検出を行う。

*   **正規化:** フレーム内の信号の振幅変動の影響を抑えるために正規化を行う。
*   **高速自己相関:** FFTを用いて効率的にACFを計算する (`_compute_autocorrelation`)。
*   **ピーク探索:** 事前定義されたピッチ範囲 (`min_f0`, `max_f0`) に対応するラグ（周期）の範囲内で、ACFの最大ピークを探す (`_find_peak`)。
*   **ピッチと周期確信度:** 最大ピークを与えるラグから基本周波数 \(f_{time}\) を算出し、正規化されたピーク値を周期性の確信度 \(p_{time}\) とする。ピークが不明瞭な場合（閾値以下）は \(f_{time}=0, p_{time}=0\) とする。

この時間領域での推定は、特に低周波成分やノイズが多い場合に周波数領域解析を補完する役割を果たす。

**2.2 周波数領域解析と倍音モデリング**

時間分解能を確保しつつ周波数成分を分析するため、STFTやCQTなどのフィルタバンクを用いる (`initialize_filterbank`)。得られたスペクトルフレームに対して、以下の分析を行う。

*   **倍音構造スコア (`_calculate_harmonic_score`):** 時間領域で推定されたピッチ \(f_{time}\) が有効な場合、その整数倍にあたる周波数（倍音）のエネルギー分布を評価する。
    1.  想定される倍音周波数 \(h \cdot f_{time}\) (\(h=1, 2, ..., H_{max}\)) に最も近い周波数ビンのエネルギー \(E_h\) を抽出する。
    2.  各倍音に対して、その倍音周波数ビン専用の**単変量ガウス背景モデル** (`GaussianBackgroundModel`) を用いて、現在のエネルギー \(E_h\) が背景からどの程度逸脱しているか（Zスコア \(\Delta_h\)）を計算する。
    3.  倍音のエネルギー \(E_h\) と逸脱度 \(\Delta_h\) を、倍音次数 \(h\) に応じて重み付け（例: \(1/h\)）して合計し、倍音構造全体の整合度を示すスコア \(H_{score}\) を算出する。逸脱度が大きいほど、またエネルギーが大きいほどスコアは高くなる。
    4.  同時に、各倍音の背景モデルをオンラインで更新する。イベント中や倍音が減衰していると判断される場合は、更新速度を調整する。
*   **適応的倍音数 (`adaptive_harmonics`):** オプションとして、フレームのスペクトル重心などに基づいて、分析に用いる倍音数 \(H_{used}\) を動的に調整することも可能。

**2.3 動的ガウス背景モデルと多次元特徴ベクトル**

アルゴリズムの中核となるのが、多次元特徴ベクトルに対する動的背景モデルである。

*   **特徴ベクトル \(\mathbf{r}(t)\):** 各フレーム \(t\) において、複数の特徴量を組み合わせて \(D\) 次元の特徴ベクトルを構築する (`_extract_feature_vector`)。標準的な構成は以下の3次元である。
    1.  \(\log(1 + f_{time})\): 時間領域ピッチ（対数スケール、非有声時は0）。
    2.  \(p_{time}\): 時間領域の周期確信度。
    3.  \(H_{score}\): 周波数領域の倍音整合度スコア。
    （オプションでフレームエネルギー比率などを追加し、4次元以上に拡張可能）
*   **背景モデル:** 背景（非イベント時）の特徴ベクトルの分布を、平均 \(\boldsymbol{\mu}\) と共分散行列 \(\Sigma\) を持つ多次元ガウス分布でモデル化する。
*   **逸脱度 (マハラノビス距離 Zスコア):** 現在のフレームの特徴ベクトル \(\mathbf{r}(t)\) が、現在の背景モデルからどの程度統計的に離れているかをマハラノビス距離 \(z(t)\) で定量化する。
    \[ z(t) = \sqrt{(\mathbf{r}(t)-\boldsymbol{\mu})^\top \Sigma^{-1} (\mathbf{r}(t)-\boldsymbol{\mu})} \]
    この \(z(t)\) が大きいほど、現在のフレームが背景（ノイズや定常音）とは異なる「イベント」である可能性が高いことを示す。
*   **オンライン更新 (`_update_background_model`):** 指数移動平均を用いて \(\boldsymbol{\mu}\) と \(\Sigma\) を逐次更新する。更新係数 \(\alpha\) は、後述するイベント状態に応じて変化させる。
    \[ \boldsymbol{\mu} \leftarrow \alpha \boldsymbol{\mu} + (1-\alpha) \mathbf{r}(t) \]
    \[ \Sigma \leftarrow \alpha \Sigma + (1-\alpha) (\mathbf{r}(t)-\boldsymbol{\mu})(\mathbf{r}(t)-\boldsymbol{\mu})^\top + \epsilon \mathbf{I} \]
    （\(\epsilon\) は数値安定化のための正則化項）
*   **適応的更新係数:** イベント状態 (`in_event`) に応じて更新係数を \(\alpha_{base}\)（非イベント時、速い更新）と \(\alpha_{event}\)（イベント時、遅い更新）で切り替える。これにより、イベント発生時に信号成分が背景モデルに混入するのを防ぎつつ、非イベント時には背景の変化に追従する。

**2.4 動的アンチパターン検出**

上記の背景モデルは、統計的に「通常」の状態からの逸脱を検出する。これにより、定常的なノイズだけでなく、予期しないスペクトルパターンや非周期的な音（アンチパターン）も、背景モデルからの大きな逸脱として捉えることができる。特に、周波数ビンごとの背景モデル (`freq_bg_models`) と倍音ごとの背景モデル (`harmonic_models`) は、スペクトル上の局所的なノイズや外れ値の影響を評価・抑制するのに役立つ。

**2.5 単一メタパラメータ \(\theta\) による統合制御 (`set_theta`)**

アルゴリズムの挙動を決定する複数の内部パラメータを、単一のメタパラメータ \(\theta\) に連動させる。

*   **閾値:** イベント検出に用いるZスコア閾値 `threshold` は \(c_T \cdot \theta\) として設定される。
*   **背景更新速度:** 基本更新係数 \(\alpha_{base}\) は \(\exp(-c_\alpha / \theta)\) で計算され、\(\theta\) が大きいほど更新が遅く（安定重視）、小さいほど速く（感度重視）なる。イベント中の更新係数 \(\alpha_{event}\) も \(\alpha_{base}\) に連動する。
*   **イベント確率/状態遷移:** スペクトル逸脱スコアからイベント確率 \(p_{event}\) を計算する際のロジスティック関数のパラメータ \(a, b\) や、状態遷移のヒステリシス閾値 (`onset_prob`, `offset_prob`)、オフセット確定に必要な待機フレーム数 (`offset_wait_frames`) なども \(\theta\) に依存して調整される。
*   **ノート後処理:** 最小ノート長やノート統合のためのギャップ時間なども \(\theta\) に応じてスケーリングされる。

これにより、\(\theta\) を調整するだけで、検出器全体の感度、時間分解能、ノイズ耐性のバランスを直感的に制御できる。

**3. 処理フローとイベント検出**

1.  **フレーム処理ループ:** 入力音声をフレーム分割し、各フレームで以下を実行。
2.  **特徴ベクトル抽出:** 時間領域ピッチ/確信度と周波数領域倍音スコアから特徴ベクトル \(\mathbf{r}(t)\) を計算。
3.  **逸脱度計算:** 背景モデル (\(\boldsymbol{\mu}, \Sigma\)) を用いてマハラノビス距離 \(z(t)\) を計算。
4.  **スペクトル逸脱スコア計算:** 周波数ビンごとの背景モデル (`freq_bg_models`) からの逸脱度を合計し、スペクトル全体の逸脱スコア \(S(t)\) を計算 (`_compute_spectrum_deviation`)。
5.  **イベント確率計算:** \(S(t)\) をロジスティック関数でイベント確率 \(p_{event}(t)\) に変換 (`_logistic_transform`)。
6.  **イベント状態遷移:** \(p_{event}(t)\) とヒステリシス閾値 (`onset_prob`, `offset_prob`)、および倍音減衰情報 (`_check_pitch_decay_event`, `_harmonic_decay_metric`) を用いて、ステートマシンによりイベント状態 (`in_event`) を更新し、オンセット/オフセットフレームを記録 (`_detect_events`)。
7.  **背景モデル更新:** イベント状態に応じて決定された更新係数 \(\alpha\) を用いて、多次元背景モデル (\(\boldsymbol{\mu}, \Sigma\)) および周波数ビン/倍音背景モデルを更新 (`_update_background_model`, `_compute_spectrum_deviation` 内, `_calculate_harmonic_score` 内)。
8.  **ピッチ推定:** イベント中であれば、特徴ベクトルやスペクトルピーク等から最終的なピッチ（単音または多音）を推定 (`_determine_final_pitch`, `_determine_multiple_pitches`)。
9.  **ノート生成と後処理:** 検出されたオンセット/オフセットフレームと推定ピッチからノートリストを生成し、短すぎるノートの除去や近接ノートの統合などの後処理 (`_post_process_notes`) を行う。

**4. 実装上の考慮事項**

*   **計算効率:** FFTや行列演算が主要な計算ボトルネックとなる。NumbaなどのJITコンパイラによる最適化が有効である。
*   **メモリ管理:** 長時間音声の場合、周波数ビンごとの背景モデル (`freq_bg_models`) や倍音モデル (`harmonic_models`) がメモリを消費する。未使用モデルの定期的な削除 (`_prune_harmonic_models`) が重要となる。
*   **パラメータ調整:** \(c_T, c_\alpha, \gamma_{slow}\) などの係数は、ターゲットとする音源の種類やノイズレベルに応じて微調整が必要となる場合がある。\(\theta\) による大まかな調整の後、これらの係数でファインチューニングを行う。

**5. 結論**

ONDE-FIVEアルゴリズムは、時間領域と周波数領域の情報を効果的に統合し、動的な背景モデルを用いてノイズやアンチパターンに対する頑健性を高めた音響イベント検出手法である。多次元特徴ベクトルとマハラノビス距離に基づく逸脱度評価、イベント状態に応じた適応的な背景更新、そして単一メタパラメータ \(\theta\) による統一的な制御機構が、本手法の独自性と有効性を支えている。これにより、リアルタイム処理性能を維持しつつ、多様な音響環境下での高精度なピッチ・オンセット・オフセット検出が可能となる。
