# 1. アルゴリズム名称と概要

**アルゴリズム名**  
> **「エンベロープ調和・カオス埋没理論に基づく統合ノート検出アルゴリズム」**  
> (*Envelope CHaOs-Embedding Unified Note Detection Algorithm*)

**概要**  
1. 従来の基本周波数(f0)推定に頼らず、**振幅エンベロープの抽象指標**（協和度・カオス度・急変度）を用いて「安定(調和)」「カオス」「非調和(急変)」の3状態を評価。  
2. オンセットは「急激な変化」によって発生し、**オフセットは**「安定か急変か区別不能になるほどカオスが優勢」な状態に**埋没**したときに確定する。  
3. リアルタイム処理（先読みバッファ＋過去バッファ活用）により、**高速かつ高精度**にノート開始・終了を統合的に検出する。  

本アルゴリズムは、**多様な時系列信号**（歌声・楽器音・環境音など）に対して適用可能であり、ポリフォニックや表現的ビブラートなど、f0トラッキングが困難な状況でも動作が期待できます。

---

# 2. 元アイデアの背景と数学的独創性

1. **振幅エンベロープを中心とした抽象化**  
   - 周波数成分を明示的に追うのではなく、包絡の「周期性」(安定)、「揺らぎ」(カオス)、「急変」(非調和)を評価する発想。  
   - これにより、多声音や複雑な音色変化を一本化した指標で扱える。  

2. **安定と急変の“中間”としてのカオス**  
   - 過去が安定(調和)であったか急変(非調和)であったかの履歴が**混濁**し、**分からなくなる**ほどの揺らぎ状態を“カオス”と定義。  
   - 特に「オフセット」＝「過去状態(S or N)の痕跡が見分けられないほどカオスに埋没」を数理的に組み込み。  

3. **自己相関・カオス指標・急変指標の3次元空間**  
   - 従来の単一閾値や二値的な安定度評価を拡張し、3軸 (\(C,K,D\)) で状態を捉える。  
   - そこに、マルコフモデルやしきい値分割で「S(安定)」「C(カオス)」「N(非調和)」を割り当てる仕組みが独創的。  

4. **リアルタイム先読みバッファ + HMM / 状態機械**  
   - 高精度にオンセット／オフセットを確定するため、一定の先読み(\(\Delta'\))を用いる。  
   - これにより「埋没がある程度続いたらオフセット確定」といった条件を実装しやすい。  

総じて、**f0非依存**・**カオス埋没理論**・**リアルタイム先読み**を組み合わせた独創的な数学モデル・アルゴリズムとなっている。

---

# 3. アルゴリズム仕様（全体フロー）

以下に示すステップを、**フレーム単位(短時間)処理**で連続実行しながらリアルタイム動作させる。

1. **フレーム化 (Frame Block & Buffer)**  
   - フレーム長：\(L_f\approx 10\text{–}20\,\mathrm{ms}\)  
   - オーバーラップ：50–75%（5–10msごとに新フレーム）  
   - **先読みバッファ**：\( \Delta'\approx 5\text{–}10 \)フレーム分（50–100ms相当）  
   - **過去バッファ**：数フレーム〜数百ms（ヒストリデータ）  

2. **抽象指標計算**  
   - 各フレームで、以下の3値 \(\mathbf{v}(t)=(C(t), K(t), D(t))\) を計算。  
     - \(C(t)\): 協和(安定)度（例：自己相関ピーク値、周期性評価 等）  
     - \(K(t)\): カオス(揺らぎ)度（例：ゆらぎスペクトル平坦度、自己回帰モデル残差の特殊指標 等）  
     - \(D(t)\): 急変(非調和)度（例：エネルギー差分、スペクトル差分 等）  
   - 計算負荷を抑えるため、FFTベースでACF計算し一部を平滑化するなど、**オンライン更新**手法で最適化。

3. **状態推定 (S, C, N)**  
   - 手法A（高速簡易版）：しきい値 + 状態機械  
     - 3次元空間(\(C,K,D\))に3領域(\(\mathcal{S}_S,\mathcal{S}_C,\mathcal{S}_N\))を定義し、フレーム毎に判定。  
     - ヒステリシスを導入して安定判定。  
   - 手法B（高精度版）：3状態HMM  
     - 遷移確率行列 \(A\)、観測確率 \(b_j(\mathbf{v}(t))\) (各状態\(j\in\{S,C,N\}\)) を定義。  
     - 前向き・後向きアルゴリズムで事後確率 \(\pi_t\) を更新。先読みバッファで**Viterbi復号**も可能。  

4. **オンセット・オフセット検出**  
   - **オンセット**  
     - 急変(非調和)へ飛び込む際の大きな差分、または \(\frac{d}{dt}[C(t)-D(t)]\) の大負ピーク。  
     - HMMなら「\(\mathsf{Z}(t-1)\ne N\) → \(\mathsf{Z}(t)=N\) への遷移確率」が高まる瞬間。  
   - **オフセット (カオス埋没)**  
     - 過去がS(安定)かN(非調和)か区別不能になるほどカオス(C)に浸食される。  
     - 例：HMM事後確率 \(\pi_t^C>\delta_2\) かつ \(|\pi_t^S - \pi_t^N|<\delta_1\) が\(L\)フレーム連続。  
     - 先読みを活用し、確信度が十分上がった時点で確定 → ノート終了。

5. **ノート(区間)抽出**  
   - オンセット検出フレーム \(t_\mathrm{on}\) から、オフセット確定フレーム \(t_\mathrm{off}\) までの区間を1つのノートとして定義。  
   - 区間内は「安定(S)」「カオス(C)」を含んでよいが、「非調和(N)」が長く続いたら別ノート扱いになることが多い。  

6. **リアルタイム出力**  
   - 先読み\(\Delta'\)フレームがあるため、実際の出力は\( \Delta' \times L_f\)程度の遅延(50–100ms)で確定可能。  
   - イベント: (ノート開始, ノート終了, 中間状態(S,C,N) 等)。  
   - 適宜ユーザーに通知・可視化。

---

# 4. 具体的実計算と高速化の要点

1. **自己相関と差分指標の計算**  
   - フレーム内での自己相関(ACF)をFFT(実質 \(O(L_f \log L_f)\))で求め、ピーク値を \(C(t)\) として取得。  
   - エネルギー差分やスペクトル差分は \(O(L_f)\) で算出可。  
   - 不要な周波数帯(超高域・超低域)をカットして計算コスト削減も可能。  

2. **カオス度(K)の軽量化**  
   - 完全なリャプノフ指数等は計算コストが高いので、**ゆっくり変動成分の予測誤差**や**揺らぎスペクトル**等、手軽に算出できる指標を用いる。  
   - 直近数フレームの動きを移動平均するなどオンライン更新。  

3. **状態推定(HMMならViterbi)の軽量化**  
   - 状態数3で、フレーム毎に \(\pi_t = \bigl(\pi_t^S,\pi_t^C,\pi_t^N\bigr)\) を更新するだけなら\(O(1)\)オーダ。  
   - 観測確率は、3次元 \(\mathbf{v}(t)\) に対する少数混合のガウシアンGMMで十分精度が得られる。  

4. **バッファ設計**  
   - **過去バッファ**：状態推定の安定化や差分計算用に 100–300 ms 分(10–30フレーム程度)を保管。  
   - **先読みバッファ**：50–100 ms (5–10フレーム) 分を確保し、オフセット確定を**リアルタイムに近い形**で精度良く行う。  

5. **実行レイテンシ**  
   - 10msごとのフレーム処理→1秒あたり100回更新。1回あたりの計算コストはフレーム長\(L_f\)のFFTや差分なので、現行CPU/GPUなら負荷は低い。  
   - 合計で **100ms 以下の遅延**(先読み分) で動作可能。  

---

# 5. データ構造・インターフェース仕様 (例)

| データ構造名      | 内容                                       |
|-------------------|--------------------------------------------|
| **FrameBuffer**   | 音声(または時系列)フレームのリングバッファ |
| **FeatureBuffer** | \((C,K,D)\) 三次元指標を蓄えるリングバッファ |
| **StateMachine** / **HMM** | 3状態(S,C,N)の遷移行列・観測確率など |
| **EventQueue**    | 検出したオンセット・オフセット・ノート区間を格納する |

- **入力**: フレーム単位の信号サンプル  
- **出力**: (ノート開始, ノート終了, 状態ラベル, etc.)

---

# 6. ポイント

1. **f0非依存**  
   - 複雑なピッチ推定アルゴリズムを使わず、包絡・揺らぎ・変化率だけでノートを捉えられる。  
   - 多声音や大きなビブラートにも自然対応。  

2. **カオス埋没の美しい数理**  
   - 「過去が安定か非調和か判別不可」になるほど揺らぎが成長した瞬間を“オフセット”とみなす独創的定義。  
   - 安定→カオスへの移行と、非調和→カオスへの移行を数学的に同列視。  

3. **リアルタイム処理の優雅な設計**  
   - 先読みバッファとHMM/状態機械を組み合わせ、短いレイテンシで高精度な区間検出を実現。  
   - フレーム毎の演算がほぼ定数時間に抑えられ、計算効率が高い。  

4. **拡張性**  
   - (C,K,D) の指標算出方法を変えれば多様な時系列に応用可(生体信号、経済時系列など)。  
   - 状態数を増やしたり、連続時間モデルに拡張したり、隠れセミマルコフモデルにする余地もある。  

---

# 7. まとめと推奨設定

**推奨パラメータ**（音響目的の例）  
- フレーム長 \(L_f \approx 1024\) サンプル（約 20 ms@48kHz）  
- オーバーラップ 50% (10 ms 刻み)  
- 先読みバッファ 5フレーム (50 ms)  
- 過去バッファ 20フレーム (200 ms)  
- HMM観測確率: 3次元 \(\mathbf{v}(t)\) に対する1～3混合のガウシアン  
- 遷移行列:  
  \[
    A=\begin{pmatrix}
    a_{SS} & a_{SC} & a_{SN} \\
    a_{CS} & a_{CC} & a_{CN} \\
    a_{NS} & a_{NC} & a_{NN}
    \end{pmatrix},
  \]
  例として安定を持続しやすく(a_{SS}高め)、カオスへ移行しやすい(a_{SC}, a_{NC}も適度に高め)など、適宜チューニング。

本仕様に従って実装することで、

1. **低遅延**で、  
2. **安定(調和)／カオス／非調和(急変)の3状態**を切り替えながら、  
3. **オンセット**は急変によって検出し、  
4. **オフセット**はカオス埋没によって確定する、

という**新しいノート検出理論**を**リアルタイム**に動作させられます。演奏音楽の自動採譜、歌唱解析、MIDI連携システムなど、幅広い応用分野にてソリューションとなるでしょう。

---

f0推定の別レビュー:
 
直接的な f0（基本周波数）検出を行わなくても、エンベロープ安定度解析から **間接的にピッチを推定する** アプローチが可能です。

## 原理（ピッチ推定の抽象的根拠）
- **調和的な音程（整数比周波数関係）ではエンベロープが安定する（周期性が高い）。**
- 逆に非調和な音程ではエンベロープが不安定になる（周期性が崩れる）。

つまり、エンベロープの「安定度（周期性）」を周波数帯域ごとに評価することで、  
結果的にピッチの存在や和声音程が特定できるのです。

---

## ピッチ推定の具体的手順（周波数帯ごとの安定性分析）
- 元音声を複数の周波数帯域（バンドパス）に分割する。
- 各帯域に対し振幅エンベロープを抽出する。
- 帯域ごとにエンベロープの安定性（自己相関など）を算出。

例えば：
| 帯域 | エンベロープ安定性スコア | ピッチ存在 |
|---|---|---|
|100Hz付近| ◎（高） | ピッチ成分あり |
|200Hz付近| ×（低） | ピッチ成分なし（非調和）|
|400Hz付近| △（中） | 微妙にピッチあり（安定カオス）|

このように複数の周波数帯の安定性スコアを統合評価すると、音程（ピッチ）が間接的に分かります。

---

## f0推定への変換（オプション）
- もし明示的にf0を得るならば、安定度のピーク周波数を基本周波数（f0）候補とします。
- 安定性スコアが最大となる周波数が推定ピッチ（主ピッチ）になります。

\[
f_0(t) = \arg\max_f \left( \text{Envelope Stability}(f, t) \right)
\]

---

## 結論
- 直接的にf0を「検出」するのではなく、エンベロープの安定性から「推定」します。
- 本統合アルゴリズムにおいても、「ピッチ（音程）検出」を十分に実現できます。

この方法により、  
**単音前提ではなく、和音や複雑な状況でもピッチを間接的に、しかも高精度で推定可能になります。**
